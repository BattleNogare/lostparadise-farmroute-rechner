<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Farmrouten-Preisrechner</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f141b; --muted:#161c24; --text:#e6f0ff; --soft:#9bb2c9;
      --green:#00e676; --red:#ff4d4f; --accent:#1aff95; --grid:#0d2a1f; --border:#1f2a36; --warn:#ffd666;
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      position:relative;
    }
    /* Börsen-Raster */
    body::before{
      content:""; position:fixed; inset:0; z-index:0; pointer-events:none;
      background:
        radial-gradient(1200px 1200px at 100% 0%,rgba(0,230,118,.06),transparent 40%),
        radial-gradient(1200px 1200px at 0% 100%,rgba(0,230,118,.06),transparent 40%),
        linear-gradient( var(--grid) 1px, transparent 1px) 0 0/ 100% 24px,
        linear-gradient(90deg, var(--grid) 1px, transparent 1px) 0 0/ 24px 100%;
      opacity:.45;
    }
    .content{position:relative; z-index:1;}

    header{position:sticky; top:0; z-index:2; backdrop-filter: blur(8px);
      background:linear-gradient(180deg,rgba(11,15,20,.92),rgba(11,15,20,.65));
      border-bottom:1px solid var(--border); box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .wrap{max-width:1200px; margin:0 auto; padding:16px;}
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{width:28px; height:28px; border-radius:8px; background:conic-gradient(from 180deg,var(--green),#0ff,var(--green));}
    h1{font-size:18px; margin:0; letter-spacing:.3px}

    .toolbar{display:grid; grid-template-columns:1fr auto; gap:12px; align-items:center; margin-top:10px;}
    .menu{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .tabs{display:flex; gap:6px}
    .tab{background:transparent; border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer}
    .tab.active{background:#0e171f}

    select, input, button, textarea{background:var(--muted); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px; font:inherit; outline:none}
    input[type="number"]{width:140px}
    input::placeholder, textarea::placeholder{color:#88a0b7}
    button{cursor:pointer; transition:.2s transform ease, .2s background ease;}
    button:hover{transform:translateY(-1px)}
    .primary{background:linear-gradient(180deg,var(--green),#09c966); color:#00160a; font-weight:700; border:none}
    .danger{background:linear-gradient(180deg,#ff7676,#ff4d4f); color:#2b0004; font-weight:700; border:none}
    .ghost{background:transparent; border:1px dashed var(--border)}
    .tag{display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#0e171f}
    .tag.green{border-color:#0a3; background:#062; color:#c6ffdd}

    /* Layout: Builder breiter, Ergebnis schmaler */
    .grid{display:grid; grid-template-columns:1.2fr .8fr; gap:16px; margin-top:16px}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .card h2{margin:0 0 6px; font-size:16px}
    .sub{color:var(--soft); font-size:13px}
    .hr{height:1px; background:linear-gradient(90deg,transparent, var(--border), transparent); margin:12px 0}
    .mini{font-size:12px; color:#9bb2c9}

    /* Builder Steps */
    #steps{min-height:20px}
    .step{border:1px dashed var(--border); border-radius:14px; padding:12px; margin:10px 0; position:relative; display:grid; gap:8px; background:#0f141b}
    .step .bar{display:flex; align-items:center; gap:8px; justify-content:space-between}
    .handle{cursor:grab; user-select:none; padding:6px 8px; border-radius:8px; background:#0e171f; border:1px solid var(--border); font-size:12px}
    .handle:active{cursor:grabbing}
    .step.dragging{opacity:.6; outline:2px dashed var(--accent)}
    .step-body{display:grid; gap:8px}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .three{display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px}
    .actions{display:flex; gap:8px; flex-wrap:wrap}

    .summary{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:13px}
    .summary .row{display:grid; grid-template-columns:1fr auto; gap:8px; padding:6px 0; border-bottom:1px solid var(--border)}
    .summary .row:last-child{border-bottom:none}

    /* KPI */
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    .kpi .box{background:#0c171f;border:1px solid var(--border);border-radius:12px;padding:10px}
    .kpi .label{color:#9bb2c9;font-size:12px}
    .kpi .val{font-size:18px;font-weight:700}

    /* Modal */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:5}
    .modal{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:16px; width:min(520px,95vw); box-shadow:0 20px 50px rgba(0,0,0,.5)}
    .modal h3{margin:0 0 8px 0}
    .modal .row{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px}
    .modal .actions{display:flex; gap:8px; justify-content:flex-end}

    /* Routenliste */
    #listView{grid-column:1/-1}
    .route-row{display:grid; grid-template-columns: 32px 1.2fr 1fr .8fr auto; gap:10px; align-items:center; padding:10px; border:1px dashed var(--border); border-radius:12px; background:#0f141b; margin:8px 0}
    .route-row .drag{cursor:grab; user-select:none; text-align:center; border:1px solid var(--border); border-radius:8px; padding:6px}
    .route-row.dragging{opacity:.6; outline:2px dashed var(--accent)}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#0e171f; font-size:12px}
    .muted{color:#9bb2c9}
    .warn{color:#2b2300; background:linear-gradient(180deg,#ffe58f,#ffd666); border-color:#e8c14c}
    .adjustments{margin-top:12px; border:1px solid var(--border); border-radius:12px; padding:10px; background:#0e171f}
    .adjustments ul{margin:8px 0 0 18px}

    /* Verkaufsliste (Endprodukte) */
    .sell-list .row{display:grid; grid-template-columns:1.4fr .8fr auto; gap:8px; margin:6px 0}
    .sell-list .row input[type="text"]{width:100%}
    .sell-list .row input[type="number"]{width:100%}
  </style>
</head>
<body>
  <div class="content">
    <header>
      <div class="wrap">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <h1>Farmrouten-Preisrechner</h1>
          <span class="tag green" title="Daten sind in dieser Datei gespeichert">In-Page Speicher</span>
        </div>

        <div class="toolbar">
          <div class="tabs">
            <button class="tab active" id="tabBuilder">Builder</button>
            <button class="tab" id="tabList">Routenliste</button>
          </div>
          <div class="menu">
            <select id="routeSelect" title="Gespeicherte Routen (in dieser Seite)"></select>
            <button id="saveBtn">Route speichern</button>
            <button id="deleteBtn" class="danger">Löschen</button>
            <button id="downloadPageBtn" class="primary" title="Neue HTML mit eingebetteten Routen herunterladen">Seite mit Routen herunterladen</button>
            <button id="exportBtn">Export</button>
            <label for="importFile" class="ghost" style="padding:10px 12px; cursor:pointer">Import<input id="importFile" type="file" accept="application/json" style="display:none"></label>
            <button id="demoBtn">Demo laden</button>
          </div>
        </div>
      </div>
    </header>

    <main class="wrap grid">
      <!-- Builder Ansicht -->
      <section class="card" id="builderView">
        <h2>Route zusammenstellen</h2>
        <div class="sub">
          Verarbeitungszeit gilt pro <strong>Run</strong> (Eingabe in <strong>Sekunden</strong>). Outputs ohne Mengenangabe werden automatisch berechnet.
          Verarbeitungskosten gelten <strong>einmalig pro Verarbeitungsschritt</strong>.  
          Endprodukte & Preise pflegst du unten in der <strong>Verkaufsliste</strong> (mehrere möglich).
        </div>

        <div class="hr"></div>
        <!-- Basisdaten -->
        <div class="two">
          <label>LKW-Größe (kg)<br/>
            <input id="lkwSize" type="number" min="1" step="1" value="2000">
          </label>
          <label>Rucksack-Größe (kg)<br/>
            <input id="backpackKg" type="number" min="1" step="1" value="150">
          </label>
        </div>

        <div class="hr"></div>
        <h3 style="margin:0 0 6px 0;font-size:15px">Verkaufsliste (Endprodukte & Preise)</h3>
        <div id="sellList" class="sell-list"></div>
        <div class="actions"><button id="addSell" type="button">+ Produkt hinzufügen</button></div>

        <div class="hr"></div>
        <div id="steps"></div>

        <div class="actions">
          <select id="addType">
            <option value="start">➕ Startpunkt</option>
            <option value="abbau">➕ Abbau</option>
            <option value="verarbeitung">➕ Verarbeitung</option>
            <option value="transportkosten">➕ Transportkosten</option>
            <option value="verkauf">➕ Verkaufsort</option>
          </select>
          <button id="addBtn" type="button">Schritt hinzufügen</button>
        </div>
        <div class="mini">Fahrzeiten werden beim Verlassen eines Ortsfelds per Popup abgefragt (wenn sich der Ort ändert).</div>
      </section>

      <aside class="card" id="resultView">
        <h2>Ergebnis &amp; Struktur</h2>
        <div class="kpi">
          <div class="box"><div class="label">Gesamtdauer</div><div id="kpiTime" class="val">–</div></div>
          <div class="box"><div class="label">Gesamtkosten</div><div id="kpiCost" class="val">–</div></div>
          <div class="box"><div class="label">Ausbeute</div><div id="kpiYield" class="val">–</div></div>
        </div>
        <div class="hr"></div>

        <div class="summary" id="summary"></div>

        <div class="hr"></div>
        <details open>
          <summary>Preis &amp; Gewinn</summary>
          <div id="priceTable" style="margin-top:8px"></div>
          <div class="row" style="display:grid;grid-template-columns:1fr auto;gap:8px;padding:6px 0;border-top:1px solid var(--border);margin-top:8px">
            <span><strong>Gesamt: Gewinn/Stunde</strong></span> <strong id="sumHourly">–</strong>
          </div>
        </details>
      </aside>

      <!-- Routenliste Ansicht -->
      <section class="card" id="listView" hidden>
        <h2>Routenliste</h2>
        <div class="sub">Alle gespeicherten Routen. Standardmäßig nach <strong>Gewinn/Stunde</strong> sortiert. Ziehe an der Griffspalte, um die Reihenfolge zu ändern.</div>
        <div class="hr"></div>

        <div id="routesList"></div>

        <div id="adjustmentsPanel" class="adjustments" style="display:none">
          <strong>Anpassungen nötig, um diese Reihenfolge zu erreichen:</strong>
          <ul id="adjustmentsList"></ul>
          <div class="mini muted" id="adjustmentsNote" style="margin-top:6px"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- In-Page Speicher (Routen + Fahrzeiten) -->
  <!--DATA-START-->
  <script id="app-data" type="application/json">{"routes":{},"travelTimes":{}}</script>
  <!--DATA-END-->

  <!-- Schritt-Vorlagen -->
  <template id="tpl-start">
    <div class="step" data-type="start" draggable="true">
      <div class="bar">
        <div><span class="handle" title="Ziehen zum Sortieren">▤</span> <span class="tag">Startpunkt</span></div>
        <div class="actions"><button class="remove danger" type="button">Entfernen</button></div>
      </div>
      <div class="step-body">
        <input data-key="where" placeholder="Start-Ort">
      </div>
    </div>
  </template>

  <template id="tpl-abbau">
    <div class="step" data-type="abbau" draggable="true">
      <div class="bar">
        <div><span class="handle" title="Ziehen zum Sortieren">▤</span> <span class="tag">Abbau</span></div>
        <div class="actions"><button class="remove danger" type="button">Entfernen</button></div>
      </div>
      <div class="step-body three">
        <input data-key="what" placeholder="Was wird abgebaut? (z. B. Kupfererz)">
        <input data-key="unitWeight" placeholder="Gewicht pro Einheit (kg)" type="number" step="0.01">
        <input data-key="where" placeholder="Abbauort">
      </div>
      <div class="step-body">
        <input data-key="timeLkw" placeholder="Zeit für LKW-Größe (Minuten)" type="number" step="1">
      </div>
    </div>
  </template>

  <template id="tpl-verarbeitung">
    <div class="step" data-type="verarbeitung" draggable="true">
      <div class="bar">
        <div><span class="handle" title="Ziehen zum Sortieren">▤</span> <span class="tag">Verarbeitung</span></div>
        <div class="actions"><button class="remove danger" type="button">Entfernen</button></div>
      </div>
      <div class="step-body two">
        <input data-key="where" placeholder="Wo wird verarbeitet?">
        <input data-key="duration" placeholder="Dauer pro Run (Sekunden)" type="number" step="1">
      </div>

      <div class="mini" style="margin:4px 0">Verarbeitungskosten (einmalig für diesen Schritt, &euro;):</div>
      <div class="step-body">
        <input data-key="processCost" placeholder="z. B. 500" type="number" step="0.01">
      </div>

      <div class="mini" style="margin:4px 0">Inputs (pro Batch – Grundrezept):</div>
      <div class="input-list" data-key="inputs"></div>
      <div class="actions"><button class="addInput" type="button">+ Input</button></div>

      <div class="mini" style="margin:4px 0">Outputs (Name + Gewicht/Einheit – Menge optional):</div>
      <div class="output-list" data-key="outputs"></div>
      <div class="actions"><button class="addOutput" type="button">+ Output</button></div>
    </div>
  </template>

  <template id="tpl-transportkosten">
    <div class="step" data-type="transportkosten" draggable="true">
      <div class="bar">
        <div><span class="handle" title="Ziehen zum Sortieren">▤</span> <span class="tag">Transportkosten</span></div>
        <div class="actions"><button class="remove danger" type="button">Entfernen</button></div>
      </div>
      <div class="step-body">
        <input data-key="transportCost" placeholder="Transportkosten (&euro;), z. B. 1200" type="number" step="0.01">
      </div>
      <div class="mini">Dieser Betrag wird zu den Gesamtkosten addiert.</div>
    </div>
  </template>

  <template id="tpl-verkauf">
    <div class="step" data-type="verkauf" draggable="true">
      <div class="bar">
        <div><span class="handle" title="Ziehen zum Sortieren">▤</span> <span class="tag">Verkaufsort</span></div>
        <div class="actions"><button class="remove danger" type="button">Entfernen</button></div>
      </div>
      <div class="step-body">
        <input data-key="where" placeholder="Wo wird verkauft?">
      </div>
    </div>
  </template>

  <template id="tpl-input-row">
    <div class="input-row" style="display:grid;grid-template-columns:1.6fr .7fr 1.2fr .8fr 1fr auto;gap:6px">
      <input data-k="name" placeholder="Item-Name">
      <input data-k="qty" placeholder="Menge / Batch" type="number" step="0.01">
      <input data-k="source" placeholder="Fundort (optional)">
      <label style="display:flex;align-items:center;gap:6px"><input data-k="purchased" type="checkbox"> einkaufen?</label>
      <input data-k="price" placeholder="Preis / Einheit (&euro;)" type="number" step="0.01" title="Nur relevant, wenn 'einkaufen?' aktiv ist">
      <button class="delInput" type="button">✕</button>
    </div>
  </template>

  <template id="tpl-output-row">
    <div class="output-row" style="display:grid;grid-template-columns:2fr .8fr .8fr auto;gap:6px">
      <input data-k="name" placeholder="Output-Name">
      <input data-k="qty" placeholder="(optional) Menge / Batch" type="number" step="0.01">
      <input data-k="unitWeight" placeholder="Gewicht / Einheit (kg)" type="number" step="0.01">
      <button class="delOutput" type="button">✕</button>
    </div>
  </template>

  <!-- Verkaufsliste-Row -->
  <template id="tpl-sell-row">
    <div class="row">
      <input data-k="pname" type="text" placeholder="Endprodukt-Name (z. B. Aluminiumbarren)">
      <input data-k="pprice" type="number" step="0.01" placeholder="Preis &euro;/Einheit">
      <button class="delSell" type="button">✕</button>
    </div>
  </template>

  <!-- Fahrzeit-Modal -->
  <div id="travelModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <h3>Fahrzeit eintragen</h3>
      <div class="row">
        <label>Von<br><input id="travelFrom" readonly></label>
        <label>Nach<br><input id="travelTo" readonly></label>
      </div>
      <label>Fahrzeit (Minuten)<br><input id="travelMinutes" type="number" min="0" step="1"></label>
      <div class="actions" style="margin-top:10px">
        <button id="travelCancel" type="button">Abbrechen</button>
        <button id="travelSave" class="primary" type="button">Speichern</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // ===== Utils =====
    function qs(s, e){return (e||document).querySelector(s);}
    function qsa(s, e){return Array.prototype.slice.call((e||document).querySelectorAll(s));}
    function uid(){return Math.random().toString(36).slice(2,9);}
    var nf=new Intl.NumberFormat('de-DE',{maximumFractionDigits:2});
    var cf=new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:2});
    function fmt(n){return nf.format(n);}
    function num(v){ if(v==null) return 0; if(typeof v==='number') return v; var s=String(v).trim().replace(/\./g,'').replace(',', '.'); var n=parseFloat(s); return isNaN(n)?0:n; }
    function minutesToH(m){ var h=Math.floor(m/60), mi=Math.round(m%60); return h<=0 ? (mi+" min") : (h+" h "+mi+" min"); }

    // ===== In-Page Speicher =====
    function readStore(){ try{ var n=qs('#app-data'); return n? JSON.parse(n.textContent||'{}') : {routes:{},travelTimes:{}}; }catch(e){ return {routes:{},travelTimes:{}}; } }
    function writeStore(store){ var n=qs('#app-data'); if(n) n.textContent=JSON.stringify(store); }
    function downloadPage(){ var html='<!doctype html>'+document.documentElement.outerHTML; var blob=new Blob([html],{type:'text/html'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='index.html'; a.click(); URL.revokeObjectURL(a.href); }

    // ===== Verkaufsliste =====
    function addSellRow(pname, price){
      var row=qs('#tpl-sell-row').content.firstElementChild.cloneNode(true);
      var list=qs('#sellList'); list.appendChild(row);
      if(pname) qs('[data-k="pname"]',row).value=pname;
      if(price!=null) qs('[data-k="pprice"]',row).value=price;
      row.addEventListener('input', recalc);
      qs('.delSell',row).addEventListener('click', function(){ row.remove(); recalc(); });
    }
    function getSellList(){
      return qsa('#sellList .row').map(function(r){
        var n=qs('[data-k="pname"]',r).value.trim();
        var p=num(qs('[data-k="pprice"]',r).value);
        if(!n) return null;
        return {name:n, price:(p>0?p:null)};
      }).filter(Boolean);
    }
    function setSellList(arr){
      var list=qs('#sellList'); list.innerHTML='';
      (arr||[]).forEach(function(x){ addSellRow(x.name, x.price); });
      if((arr||[]).length===0){ addSellRow('', null); }
    }

    // ===== Templates / Steps =====
    var TPLS={
      start: function(){return qs('#tpl-start').content.firstElementChild.cloneNode(true);},
      abbau: function(){return qs('#tpl-abbau').content.firstElementChild.cloneNode(true);},
      verarbeitung: function(){ var el=qs('#tpl-verarbeitung').content.firstElementChild.cloneNode(true); addInputRow(el); addOutputRow(el); return el; },
      transportkosten: function(){return qs('#tpl-transportkosten').content.firstElementChild.cloneNode(true);},
      verkauf: function(){return qs('#tpl-verkauf').content.firstElementChild.cloneNode(true);}
    };
    function addInputRow(stepEl){
      var row=qs('#tpl-input-row').content.firstElementChild.cloneNode(true);
      qs('[data-key="inputs"]', stepEl).appendChild(row);
      qs('.delInput',row).addEventListener('click', function(){ row.remove(); recalc(); });
      row.addEventListener('input', recalc);
    }
    function addOutputRow(stepEl){
      var row=qs('#tpl-output-row').content.firstElementChild.cloneNode(true);
      qs('[data-key="outputs"]', stepEl).appendChild(row);
      qs('.delOutput',row).addEventListener('click', function(){ row.remove(); recalc(); });
      row.addEventListener('input', recalc);
    }
    function attachStepControls(stepEl){
      qs('.remove',stepEl)?.addEventListener('click', function(){ stepEl.remove(); recalc(); });
      qs('.addInput',stepEl)?.addEventListener('click', function(){ addInputRow(stepEl); });
      qs('.addOutput',stepEl)?.addEventListener('click', function(){ addOutputRow(stepEl); });
      stepEl.addEventListener('input', function(){ recalc(); });
      // Drag
      stepEl.addEventListener('dragstart', function(e){ stepEl.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain','drag'); });
      stepEl.addEventListener('dragend', function(){ stepEl.classList.remove('dragging'); recalc(); });
      // Fahrzeit-Abfrage bei Ortswechsel (on blur)
      var where=qs('[data-key="where"]', stepEl);
      if(where){ where.addEventListener('blur', function(){ handlePlaceBlur(stepEl); }); }
    }
    function addStep(type){
      var el=TPLS[type]?TPLS[type]():null; if(!el) return null;
      el.dataset.type=type; attachStepControls(el); qs('#steps').appendChild(el); return el;
    }
    // DnD Container für Steps
    (function(){
      var container=qs('#steps');
      function afterEl(container,y){
        var els=[].slice.call(container.querySelectorAll('.step:not(.dragging)'));
        return els.reduce(function(closest,child){
          var box=child.getBoundingClientRect();
          var offset=y - box.top - box.height/2;
          if(offset<0 && offset>closest.offset){ return {offset:offset, element:child}; }
          else { return closest; }
        }, {offset:Number.NEGATIVE_INFINITY}).element;
      }
      document.addEventListener('dragover', function(e){
        var dragging=qs('.step.dragging'); if(!dragging) return;
        e.preventDefault();
        var a=afterEl(container, e.clientY);
        if(a==null){ container.appendChild(dragging); } else { container.insertBefore(dragging, a); }
      });
    })();

    // ===== Route Build/Load =====
    var currentRouteId=null;
    function getRoute(){
      var steps=[];
      qsa('#steps .step').forEach(function(step){
        var type=step.dataset.type;
        if(type==='start'){
          steps.push({type:type, where: qs('[data-key="where"]',step).value.trim()});
        } else if(type==='abbau'){
          steps.push({type:type,
            what: qs('[data-key="what"]',step).value.trim(),
            unitWeight: num(qs('[data-key="unitWeight"]',step).value),
            where: qs('[data-key="where"]',step).value.trim(),
            timeLkw: num(qs('[data-key="timeLkw"]',step).value)
          });
        } else if(type==='verarbeitung'){
          var inputs=qsa('[data-key="inputs"] .input-row',step).map(function(row){
            return {
              name: qs('[data-k="name"]',row).value.trim(),
              qty: num(qs('[data-k="qty"]',row).value),
              source: qs('[data-k="source"]',row).value.trim(),
              purchased: qs('[data-k="purchased"]',row).checked,
              price: num(qs('[data-k="price"]',row).value)
            };
          }).filter(function(i){return i.name && i.qty>0;});
          var outputs=qsa('[data-key="outputs"] .output-row',step).map(function(row){
            return {
              name: qs('[data-k="name"]',row).value.trim(),
              qty: num(qs('[data-k="qty"]',row).value), // optional
              unitWeight: num(qs('[data-k="unitWeight"]',row).value)
            };
          }).filter(function(o){return o.name;});
          steps.push({type:type,
            where: qs('[data-key="where"]',step).value.trim(),
            duration: num(qs('[data-key="duration"]',step).value), // Sekunden pro Run
            processCost: num(qs('[data-key="processCost"]',step).value), // einmalig
            inputs: inputs,
            outputs: outputs
          });
        } else if(type==='transportkosten'){
          steps.push({type:type, transportCost: num(qs('[data-key="transportCost"]',step).value)});
        } else if(type==='verkauf'){
          steps.push({type:type, where: qs('[data-key="where"]',step).value.trim()});
        }
      });
      var store=readStore();
      return {
        id: currentRouteId || uid(),
        name: (qs('#routeSelect') && qs('#routeSelect').selectedOptions[0]) ? qs('#routeSelect').selectedOptions[0].textContent : 'Unbenannt',
        lkwSize: Math.max(1, num(qs('#lkwSize').value)||2000),
        backpackKg: Math.max(1, num(qs('#backpackKg').value)||150),
        sellList: getSellList(), // [{name, price}]
        steps: steps,
        travelTimes: store.travelTimes || {}
      };
    }
    function setRoute(route){
      currentRouteId = route.id || uid();
      qs('#lkwSize').value = route.lkwSize || 2000;
      qs('#backpackKg').value = route.backpackKg || 150;
      setSellList(route.sellList||[]);
      var box=qs('#steps'); box.innerHTML='';
      (route.steps||[]).forEach(function(s){
        var el=addStep(s.type); if(!el) return;
        if(s.type==='start'){
          qs('[data-key="where"]',el).value=s.where||'';
        } else if(s.type==='abbau'){
          qs('[data-key="what"]',el).value=s.what||'';
          qs('[data-key="unitWeight"]',el).value=s.unitWeight||'';
          qs('[data-key="where"]',el).value=s.where||'';
          qs('[data-key="timeLkw"]',el).value=s.timeLkw||'';
        } else if(s.type==='verarbeitung'){
          qs('[data-key="where"]',el).value=s.where||'';
          qs('[data-key="duration"]',el).value=s.duration||'';
          qs('[data-key="processCost"]',el).value=s.processCost||'';
          var listI=qs('[data-key="inputs"]',el); listI.innerHTML='';
          (s.inputs||[]).forEach(function(inp){
            addInputRow(el);
            var row=listI.lastElementChild;
            qs('[data-k="name"]',row).value=inp.name||'';
            qs('[data-k="qty"]',row).value=inp.qty||'';
            qs('[data-k="source"]',row).value=inp.source||'';
            qs('[data-k="purchased"]',row).checked=!!inp.purchased;
            qs('[data-k="price"]',row).value=inp.price||'';
          });
          var listO=qs('[data-key="outputs"]',el); listO.innerHTML='';
          (s.outputs||[]).forEach(function(out){
            addOutputRow(el);
            var row=listO.lastElementChild;
            qs('[data-k="name"]',row).value=out.name||'';
            qs('[data-k="qty"]',row).value=out.qty||''; // optional
            qs('[data-k="unitWeight"]',row).value=out.unitWeight||'';
          });
        } else if(s.type==='transportkosten'){
          qs('[data-key="transportCost"]',el).value=s.transportCost||'';
        } else if(s.type==='verkauf'){
          qs('[data-key="where"]',el).value=s.where||'';
        }
      });
      recalc();
    }

    // ===== Fahrzeit-Popup (on blur) =====
    function travelKey(a,b){ return (a||'?')+'|'+(b||'?'); }
    function openTravelModal(from,to, cb){
      var m=qs('#travelModal'); qs('#travelFrom').value=from||''; qs('#travelTo').value=to||''; qs('#travelMinutes').value='';
      m.style.display='flex'; m.setAttribute('aria-hidden','false');
      function close(){ m.style.display='none'; m.setAttribute('aria-hidden','true'); }
      qs('#travelSave').onclick=function(){ var mins=Math.max(0, num(qs('#travelMinutes').value)); close(); cb(mins); };
      qs('#travelCancel').onclick=function(){ close(); cb(null); };
    }
    function handlePlaceBlur(stepEl){
      try{
        var stepsNodes=qsa('#steps .step');
        var idx=stepsNodes.findIndex(function(n){return n===stepEl;});
        if(idx<0) return;
        var currPlace=qs('[data-key="where"]', stepEl)?.value.trim(); if(!currPlace) return;
        var prevPlace=null;
        for(var i=idx-1;i>=0;i--){
          var node=stepsNodes[i];
          var w=qs('[data-key="where"]', node);
          if(w && w.value.trim()){ prevPlace=w.value.trim(); break; }
        }
        if(!prevPlace || prevPlace===currPlace) return;
        var store=readStore(); var key=travelKey(prevPlace, currPlace);
        if(store.travelTimes[key]!=null) return;
        openTravelModal(prevPlace, currPlace, function(mins){ if(mins==null) return; store.travelTimes[key]=mins; writeStore(store); recalc(); });
      }catch(e){}
    }

    // ===== Automatik-Hilfen =====
    function kgPerBatchAllInputs(inputs, weights){
      var sum=0;
      inputs.forEach(function(i){
        var w = weights[i.name] || 1; // Default 1 kg
        sum += Math.max(0, num(i.qty)) * w;
      });
      return sum;
    }
    function deriveOutputQuantities(outputs, weights, totalInputKg){
      var anySet = outputs.some(function(o){ return num(o.qty)>0; });
      if(anySet){ return outputs.map(function(o){ return Math.max(0, num(o.qty)); }); }
      var count = outputs.length;
      if(count===1){
        var ow = Math.max(0.0001, weights[outputs[0].name] || 1);
        return [ Math.max(0, Math.floor(totalInputKg / ow)) ];
      }
      var shareKg = totalInputKg / count;
      return outputs.map(function(o){
        var ow = Math.max(0.0001, weights[o.name] || 1);
        return Math.max(0, Math.floor(shareKg / ow));
      });
    }

    // ===== Berechnung einer Route (Schritt-Reihenfolge + Preisvorschläge) =====
    function compute(route){
      var baseKg = route.lkwSize>0? route.lkwSize : 2000; // LKW-Größe
      var backpackKg = route.backpackKg>0? route.backpackKg : 150;

      var inventory = {};   // item -> units
      var weights = {};     // item -> kg per unit
      var miningTime=0, driveTime=0, procTime=0; // Minuten
      var purchaseCost=0, transportCostTotal=0, processingCostTotal=0;
      var log=[];

      var store=readStore();
      var lastPlace=null;

      // --- Schrittweise durchgehen, Fahrten genau dazwischen einfügen ---
      (route.steps||[]).forEach(function(s, idx){
        var thisPlace = (s.type==='start'||s.type==='abbau'||s.type==='verkauf'||s.type==='verarbeitung') ? (s.where||'') : '';

        // Fahrzeit falls Ortswechsel zwischen vorherigem Ort und diesem Schritt
        if(thisPlace && lastPlace && lastPlace!==thisPlace){
          var key= (lastPlace||'?')+'|'+(thisPlace||'?');
          var m=store.travelTimes[key];
          if(m!=null){
            driveTime += Math.max(0,num(m));
            log.push('Fahrt '+lastPlace+' → '+thisPlace+': +'+fmt(m)+' min.');
          } else {
            log.push('Fahrt '+lastPlace+' → '+thisPlace+': (keine Zeit hinterlegt)');
          }
        }

        // Schritt ausführen
        if(s.type==='start'){
          log.push('Start @ '+(s.where||'?'));
        }
        else if(s.type==='abbau'){
          var perUnit=Math.max(0, num(s.unitWeight));
          var units = perUnit>0 ? Math.floor(baseKg / perUnit) : 0;
          var what = s.what || ('Rohstoff_'+(idx+1));
          inventory[what]=(inventory[what]||0)+units;
          if(perUnit>0) weights[what]=perUnit;
          var t = Math.max(0, num(s.timeLkw));
          miningTime += t;
          log.push('Abbau '+what+' @ '+(s.where||'?')+': '+fmt(units)+' Einheiten (à '+(perUnit||1)+' kg). Zeit +'+fmt(t)+' min.');
        }
        else if(s.type==='transportkosten'){
          var c=Math.max(0,num(s.transportCost));
          transportCostTotal+=c;
          log.push('Transportkosten: +'+cf.format(c));
        }
        else if(s.type==='verarbeitung'){
          var inputs=s.inputs||[];
          var outputs=s.outputs||[];
          if(inputs.length===0 || outputs.length===0){
            log.push('Verarbeitung @ '+(s.where||'?')+': Input/Output unvollständig – übersprungen.');
          }else{
            // Gewichte der Outputs sichern
            outputs.forEach(function(o){ var w=Math.max(0,num(o.unitWeight)) || (weights[o.name]||1); weights[o.name]=w; });

            var durSec = Math.max(0, num(s.duration));  // Sekunden pro RUN
            var durMin = durSec/60;

            var nonPurchased=inputs.filter(function(i){return !i.purchased;});
            var purchased=inputs.filter(function(i){return i.purchased;});

            var totalInputKgPerBatch = kgPerBatchAllInputs(inputs, weights);

            var runs=0, batchesTotal=0;
            while(true){
              var batchesByInventory = Infinity;
              if(nonPurchased.length>0){
                batchesByInventory = nonPurchased.reduce(function(min,i){
                  var avail=inventory[i.name]||0;
                  var need=Math.max(1, num(i.qty));
                  var can=Math.floor(avail/need);
                  return Math.min(min, can);
                }, Infinity);
              } else { batchesByInventory = 999999; }
              if(batchesByInventory<=0) break;

              var kgBatch = totalInputKgPerBatch;
              var batchesByBackpack = kgBatch>0 ? Math.floor(backpackKg / kgBatch) : batchesByInventory;
              if(kgBatch>0 && batchesByBackpack<=0) break;

              var batchesThisRun = Math.max(1, Math.min(batchesByInventory, batchesByBackpack || batchesByInventory));

              nonPurchased.forEach(function(i){
                var need=Math.max(0, num(i.qty));
                inventory[i.name]=(inventory[i.name]||0) - need*batchesThisRun;
              });
              purchased.forEach(function(i){
                var need=Math.max(0, num(i.qty));
                var price=Math.max(0, num(i.price));
                purchaseCost += need*batchesThisRun*price;
              });

              var qPerBatchArr = deriveOutputQuantities(outputs, weights, totalInputKgPerBatch);
              outputs.forEach(function(o,ix){
                var qPerBatch = Math.max(0, num(o.qty)) || qPerBatchArr[ix] || 0;
                inventory[o.name]=(inventory[o.name]||0) + qPerBatch*batchesThisRun;
              });

              procTime += durMin; // Zeit/Run
              runs++; batchesTotal+=batchesThisRun;
              if(batchesThisRun<=0) break;
            }

            // Einmalige Verarbeitungskosten
            var stepCost = Math.max(0, num(s.processCost));
            if(stepCost>0){
              processingCostTotal += stepCost;
              log.push('Verarbeitungskosten @ '+(s.where||'?')+': +'+cf.format(stepCost)+' (einmalig)');
            }

            var inputsTxt = inputs.map(function(i){
              var t=fmt(num(i.qty))+'× '+i.name;
              if(i.source) t+=' ['+i.source+']';
              if(i.purchased) t+=' (gekauft '+cf.format(num(i.price))+')';
              return t;
            }).join(' + ');
            var auto = deriveOutputQuantities(outputs, weights, totalInputKgPerBatch);
            var dbgOut = outputs.map(function(o,ix){
              var q = Math.max(0, num(o.qty)) || auto[ix] || 0;
              return fmt(q)+'× '+o.name;
            }).join(' + ');
            var durSecTxt = Math.round(durMin*60);
            log.push('Verarbeitung @ '+(s.where||'?')+': '+runs+' Runs, '+fmt(batchesTotal)+' Batches/Run: '+inputsTxt+' → '+dbgOut+' je Batch. Dauer/Run: '+fmt(durSecTxt)+' s');
          }
        }
        else if(s.type==='verkauf'){
          log.push('Verkaufsort: '+(s.where||'?'));
        }

        // Ort aktualisieren
        if(thisPlace){ lastPlace=thisPlace; }
      });

      var totalMinutes = miningTime + driveTime + procTime;

      // === Endprodukte laut Verkaufsliste ===
      var sellList = (route.sellList||[]).filter(function(x){return x && x.name;});
      var endProducts = sellList.map(function(x){
        var units = Math.max(0, Math.floor((inventory[x.name]||0)));
        return {name:x.name, units:units, price: (x.price>0? x.price : null)};
      });

      // Kosten
      var totalCost = purchaseCost + transportCostTotal + processingCostTotal;
      var hours = totalMinutes/60;

      // ---- Preisvorschläge (≤ 500k €/h) ----
      var totalUnits = endProducts.reduce(function(s,ep){return s+ep.units;},0);
      var BE_avg = totalUnits>0 ? (totalCost / totalUnits) : 0;
      var targetRevenue = (hours>0) ? (500000*hours + totalCost) : totalCost; // damit Gewinn/h ≤ 500k, bei 0h → nur Kosten
      var fixedRevenue = endProducts.reduce(function(s,ep){ return s + ((ep.price>0)? ep.price*ep.units : 0); }, 0);
      var varUnits = endProducts.reduce(function(s,ep){ return s + ((ep.price>0)? 0 : ep.units); }, 0);

      var suggested = {}; // name -> suggested price
      if(totalUnits>0){
        if(varUnits>0){
          // fehlende Preise so setzen, dass Ziel erreicht wird
          var perUnitVar = (targetRevenue - fixedRevenue) / Math.max(1, varUnits);
          var perUnitVarCapped = Math.max(0, Math.max(BE_avg, perUnitVar));
          endProducts.forEach(function(ep){
            if(!(ep.price>0)){ suggested[ep.name] = perUnitVarCapped; }
            else { suggested[ep.name] = ep.price; }
          });
        }else{
          // alle haben Preise → ggf. proportional absenken
          if(fixedRevenue>0 && fixedRevenue>targetRevenue){
            var f = targetRevenue / fixedRevenue; // <1
            endProducts.forEach(function(ep){
              var sp = (ep.price>0? ep.price : 0)*f;
              suggested[ep.name] = Math.max(BE_avg, sp);
            });
          }else{
            endProducts.forEach(function(ep){ suggested[ep.name] = (ep.price>0? ep.price : BE_avg); });
          }
        }
      }

      // Umsatz/Gewinn mit "effektivem" Preis (Preis falls gesetzt, sonst Vorschlag)
      var revenue = endProducts.reduce(function(sum, ep){
        var eff = (ep.price>0) ? ep.price : (suggested[ep.name]||0);
        return sum + eff * ep.units;
      }, 0);
      var profit = revenue - totalCost;
      var hourlyProfit = hours>0 ? (profit / hours) : 0;

      // Endprodukte anreichern (für Tabelle)
      var endProductsRich = endProducts.map(function(ep){
        var s = suggested[ep.name] || null;
        var effective = (ep.price>0) ? ep.price : (s||0);
        var revenueEP = effective * ep.units;
        return { name: ep.name, units: ep.units, price: ep.price, suggested: s, effective: effective, revenue: revenueEP };
      });

      return {
        miningTime, driveTime, procTime, totalMinutes,
        purchaseCost, transportCostTotal, processingCostTotal, totalCost,
        endProducts: endProductsRich, revenue, profit, hourlyProfit,
        BE_avg, targetRevenue, log
      };
    }

    function renderSummary(calc){
      qs('#kpiTime').textContent = minutesToH(calc.totalMinutes);
      qs('#kpiCost').textContent = cf.format(calc.totalCost);

      // Ausbeute: Liste der Endprodukte + Stückzahlen
      var yieldTxt = calc.endProducts.length
        ? calc.endProducts.map(function(ep){ return fmt(ep.units)+' × '+ep.name; }).join(', ')
        : '–';
      qs('#kpiYield').textContent = yieldTxt;

      // Struktur – bereits in Schritt-Reihenfolge aufgebaut
      var box=qs('#summary'); box.innerHTML='';
      function row(label, value){
        var r=document.createElement('div'); r.className='row';
        r.style.display='grid'; r.style.gridTemplateColumns='1fr auto'; r.style.gap='8px';
        r.style.padding='6px 0'; r.style.borderBottom='1px solid var(--border)';
        r.innerHTML = '<span>'+label+'</span><strong>'+value+'</strong>'; box.appendChild(r);
      }
      row('Mining', minutesToH(calc.miningTime)+' ('+fmt(calc.miningTime)+' min)');
      row('Fahrten', minutesToH(calc.driveTime)+' ('+fmt(calc.driveTime)+' min)');
      row('Verarbeitung', minutesToH(calc.procTime)+' ('+fmt(calc.procTime)+' min)');
      row('Kosten (Einkauf)', cf.format(calc.purchaseCost));
      row('Transportkosten', cf.format(calc.transportCostTotal));
      row('Verarbeitungskosten (fix)', cf.format(calc.processingCostTotal));
      row('Gesamtkosten', cf.format(calc.totalCost));

      var det=document.createElement('details'); det.open=true; det.innerHTML='<summary>Routenstruktur</summary>';
      var ul=document.createElement('ul'); ul.style.marginTop='8px';
      calc.log.forEach(function(t){ var li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
      det.appendChild(ul); box.appendChild(det);

      // Preis & Gewinn Tabelle (mit Vorschlag ≤ 500k €/h)
      var pBox=qs('#priceTable'); pBox.innerHTML='';
      if(calc.endProducts.length===0){
        pBox.innerHTML='<div class="mini muted">Keine Endprodukte in der Verkaufsliste.</div>';
      }else{
        var tbl=document.createElement('div');
        tbl.style.display='grid'; tbl.style.gridTemplateColumns='1.2fr .6fr .8fr .9fr .8fr .9fr'; tbl.style.gap='8px';
        tbl.innerHTML='<div><strong>Endprodukt</strong></div><div><strong>Menge</strong></div><div><strong>Dein Preis</strong></div><div><strong>Vorschlag (≤ 500k/h)</strong></div><div><strong>eff. Preis</strong></div><div><strong>Umsatz</strong></div>';
        calc.endProducts.forEach(function(ep){
          var priceDisp = (ep.price>0)? cf.format(ep.price) : '<span class="muted">–</span>';
          var suggDisp  = (ep.suggested!=null)? cf.format(ep.suggested) : '<span class="muted">–</span>';
          var row1=document.createElement('div'); row1.textContent=ep.name; tbl.appendChild(row1);
          var row2=document.createElement('div'); row2.textContent=fmt(ep.units); tbl.appendChild(row2);
          var row3=document.createElement('div'); row3.innerHTML=priceDisp; tbl.appendChild(row3);
          var row4=document.createElement('div'); row4.innerHTML=suggDisp; tbl.appendChild(row4);
          var row5=document.createElement('div'); row5.textContent=cf.format(ep.effective); tbl.appendChild(row5);
          var row6=document.createElement('div'); row6.textContent=cf.format(ep.revenue); tbl.appendChild(row6);
        });
        var tot1=document.createElement('div'); tot1.innerHTML='<strong>Gesamtumsatz</strong>'; tbl.appendChild(tot1);
        var t2=document.createElement('div'); t2.textContent=''; tbl.appendChild(t2);
        var t3=document.createElement('div'); t3.textContent=''; tbl.appendChild(t3);
        var t4=document.createElement('div'); t4.textContent=''; tbl.appendChild(t4);
        var t5=document.createElement('div'); t5.textContent=''; tbl.appendChild(t5);
        var t6=document.createElement('div'); t6.innerHTML='<strong>'+cf.format(calc.revenue)+'</strong>'; tbl.appendChild(t6);
        var g1=document.createElement('div'); g1.innerHTML='<strong>Gesamtgewinn</strong>'; tbl.appendChild(g1);
        var g2=document.createElement('div'); g2.textContent=''; tbl.appendChild(g2);
        var g3=document.createElement('div'); g3.textContent=''; tbl.appendChild(g3);
        var g4=document.createElement('div'); g4.textContent=''; tbl.appendChild(g4);
        var g5=document.createElement('div'); g5.textContent=''; tbl.appendChild(g5);
        var g6=document.createElement('div'); g6.innerHTML='<strong>'+cf.format(calc.revenue - calc.totalCost)+'</strong>'; tbl.appendChild(g6);
        pBox.appendChild(tbl);

        var hint=document.createElement('div');
        hint.className='mini muted';
        hint.style.marginTop='6px';
        hint.textContent='Vorschläge berücksichtigen den Zielwert ≤ 500 000 €/h. Untergrenze je Produkt ist der durchschnittliche Break-even pro Einheit.';
        pBox.appendChild(hint);
      }

      qs('#sumHourly').textContent = cf.format(calc.hourlyProfit);
    }

    function recalc(){ var route=getRoute(); var calc=compute(route); renderSummary(calc); }

    // ===== Routenverwaltung (Speichern/Laden) =====
    function refreshRouteSelect(selectedId){
      var sel=qs('#routeSelect'); if(!sel) return;
      var store=readStore(); var map=store.routes||{};
      sel.innerHTML='';
      var opt0=document.createElement('option'); opt0.value=''; opt0.textContent='— Gespeicherte Routen —'; sel.appendChild(opt0);
      Object.keys(map).forEach(function(id){
        var r=map[id]; var o=document.createElement('option'); o.value=id; o.textContent=r.name||id; if(id===selectedId) o.selected=true; sel.appendChild(o);
      });
    }

    // ===== Routenliste =====
    function buildListData(){
      var store=readStore(); var list=[];
      Object.keys(store.routes||{}).forEach(function(id){
        var r=store.routes[id];
        var calc=compute(r);
        list.push({
          id:id,
          name:r.name||id,
          endProducts: (r.sellList||[]).map(function(x){ return {name:x.name, price:x.price||null}; }),
          hourlyProfit: calc.hourlyProfit
        });
      });
      list.sort(function(a,b){ return (b.hourlyProfit||0) - (a.hourlyProfit||0); });
      return list;
    }

    function renderListView(){
      var list = buildListData();
      var container = qs('#routesList'); container.innerHTML='';

      list.forEach(function(item){
        var labelEP = item.endProducts.length
          ? item.endProducts.map(function(ep){ return ep.name + (ep.price? ' ('+cf.format(ep.price)+')' : ' (–)'); }).join(', ')
          : '–';
        var row=document.createElement('div');
        row.className='route-row';
        row.draggable=true;
        row.dataset.id=item.id;
        row.innerHTML = `
          <div class="drag">▤</div>
          <div><div><strong>${item.name}</strong></div><div class="muted">${labelEP}</div></div>
          <div><span class="pill">${item.endProducts.length? item.endProducts.length+' Produkte' : '—'}</span></div>
          <div><strong>${cf.format(item.hourlyProfit)}</strong><div class="mini muted">Gewinn/h</div></div>
          <div class="mini muted"></div>
        `;
        container.appendChild(row);
      });

      // Drag & Drop für Reihenfolge
      enableListDnD(container, function(newOrderIds){
        var dataById={};
        (buildListData()).forEach(function(x){ dataById[x.id]=x; });

        var margin = 1; // € pro Stunde Abstand
        var targets = {};
        var any=false;

        var ul=qs('#adjustmentsList'); ul.innerHTML='';
        var note=qs('#adjustmentsNote'); note.textContent='';
        var panel=qs('#adjustmentsPanel');

        // Heuristik: Wenn der aktuelle Gewinn/h einer Route zu niedrig ist, Hinweis "Preise pro Route proportional erhöhen".
        newOrderIds.forEach(function(id, i){
          var d=dataById[id]; if(!d) return;
          var desiredBelow = (i<newOrderIds.length-1) ? ((dataById[newOrderIds[i+1]]?.hourlyProfit)||0) + margin : -Infinity;
          var current = d.hourlyProfit||0;
          if(current < desiredBelow - 1e-9){
            any=true;
            var li=document.createElement('li');
            li.innerHTML = `<strong>${d.name}</strong>: Preise proportional erhöhen, bis ~ ${cf.format(desiredBelow)} Gewinn/h erreicht sind.`;
            ul.appendChild(li);
          }
        });

        note.textContent = 'Vorschläge sind heuristisch (Multi-Endprodukt). Genaue Ziele kannst du über die Produktpreise im Builder setzen.';
        panel.style.display = any ? 'block' : 'none';
      });
    }

    function enableListDnD(container, onOrderChanged){
      var dragEl=null;
      container.addEventListener('dragstart', function(e){
        var row=e.target.closest('.route-row'); if(!row) return;
        dragEl=row; row.classList.add('dragging'); e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain','drag');
      });
      container.addEventListener('dragend', function(e){
        if(dragEl){ dragEl.classList.remove('dragging'); dragEl=null; }
        var ids=[].map.call(container.querySelectorAll('.route-row'), function(r){return r.dataset.id;});
        if(typeof onOrderChanged==='function'){ onOrderChanged(ids); }
      });
      container.addEventListener('dragover', function(e){
        e.preventDefault();
        var dragging=container.querySelector('.route-row.dragging'); if(!dragging) return;
        var after = (function(){
          var els=[].slice.call(container.querySelectorAll('.route-row:not(.dragging)'));
          return els.reduce(function(closest,child){
            var box=child.getBoundingClientRect();
            var offset=e.clientY - box.top - box.height/2;
            if(offset<0 && offset>closest.offset){ return {offset:offset, element:child}; }
            else { return closest; }
          }, {offset:Number.NEGATIVE_INFINITY}).element;
        })();
        if(after==null){ container.appendChild(dragging); } else { container.insertBefore(dragging, after); }
      });
    }

    // ===== UI: Tabs =====
    function switchTab(name){
      var isList = (name==='list');
      qs('#tabBuilder').classList.toggle('active', !isList);
      qs('#tabList').classList.toggle('active', isList);
      qs('#builderView').hidden = isList;
      qs('#resultView').hidden  = isList;
      qs('#listView').hidden    = !isList;
      if(isList){ renderListView(); }
    }

    function renderSummaryAndMaybeList(){ recalc(); if(!qs('#listView').hidden){ renderListView(); } }

    // ===== Events =====
    window.addEventListener('DOMContentLoaded', function(){
      // Verkaufsliste
      qs('#addSell').addEventListener('click', function(){ addSellRow('', null); });

      // Add step
      qs('#addBtn')?.addEventListener('click', function(){ var t=qs('#addType').value; addStep(t); });

      // Basisdaten -> Recalc
      ['lkwSize','backpackKg'].forEach(function(id){
        var el=qs('#'+id); if(el) el.addEventListener('input', renderSummaryAndMaybeList);
      });

      // Save – sofort ins Dropdown, auswählen
      qs('#saveBtn')?.addEventListener('click', function(){
        var r=getRoute();
        if(!r.name || r.name==='Unbenannt'){
          var n=prompt('Name der Route?', r.sellList?.map(function(x){return x.name;}).filter(Boolean).join(', ') || 'Unbenannt');
          if(n) r.name=n;
        }
        if(!r.id) r.id = uid();
        var store=readStore(); store.routes[r.id]=r; writeStore(store);
        refreshRouteSelect(r.id);
        var sel=qs('#routeSelect'); if(sel){ sel.value=r.id; }
        alert('Route gespeichert. „Seite mit Routen herunterladen“, um Datei zu aktualisieren.');
        if(!qs('#listView').hidden){ renderListView(); }
      });

      // Delete
      qs('#deleteBtn')?.addEventListener('click', function(){
        var id=qs('#routeSelect').value; if(!id){ alert('Bitte Route wählen.'); return; }
        if(confirm('Route wirklich löschen?')){ var store=readStore(); delete store.routes[id]; writeStore(store); refreshRouteSelect(null); if(!qs('#listView').hidden){ renderListView(); } }
      });

      // Load
      qs('#routeSelect')?.addEventListener('change', function(e){
        var id=e.target.value; if(!id) return;
        var store=readStore(); var r=store.routes[id]; if(r){ setRoute(r); currentRouteId=id; }
      });

      // Export / Import
      qs('#exportBtn')?.addEventListener('click', function(){
        var data=readStore(); var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
        var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='routen.json'; a.click(); URL.revokeObjectURL(a.href);
      });
      qs('#importFile')?.addEventListener('change', function(e){
        var f=e.target.files && e.target.files[0]; if(!f) return;
        var rd=new FileReader();
        rd.onload=function(){
          try{
            var incoming=JSON.parse(rd.result||'{}');
            var store=readStore();
            store.travelTimes = Object.assign({}, store.travelTimes||{}, incoming.travelTimes||{});
            var src=incoming.routes || incoming || {};
            Object.keys(src).forEach(function(id){ var r=src[id]; if(!r.id) r.id=uid(); store.routes[r.id]=r; });
            writeStore(store); refreshRouteSelect(null); alert('Import abgeschlossen.');
            if(!qs('#listView').hidden){ renderListView(); }
          }catch(err){ alert('Import fehlgeschlagen: '+err.message); }
        };
        rd.readAsText(f); e.target.value='';
      });

      // Download page
      qs('#downloadPageBtn')?.addEventListener('click', downloadPage);

      // Demo
      qs('#demoBtn')?.addEventListener('click', function(){
        var demo={
          id: uid(),
          name: 'Metallschmelze Demo (Multi-Output)',
          lkwSize: 2000,
          backpackKg: 150,
          sellList: [
            {name:'Aluminiumbarren', price: 120},
            {name:'Schlacke', price: 10}
          ],
          steps: [
            {type:'start', where:'HQ'},
            {type:'abbau', what:'Rohes Bauxit', unitWeight:3, where:'Bauxitmine', timeLkw: 180},
            {type:'verarbeitung', where:'Ingenieurbüro', duration: 480, processCost: 200,
              inputs:[{name:'Rohes Bauxit', qty:10, source:'Bauxitmine', purchased:false}],
              outputs:[{name:'Feingemahlenes Bauxitpulver', unitWeight:3}]},
            {type:'verarbeitung', where:'Ingenieurbüro', duration: 720, processCost: 0,
              inputs:[{name:'Feingemahlenes Bauxitpulver', qty:10, source:'Ingenieurbüro', purchased:false},{name:'Schwefelsäure', qty:3, source:'Chemiewerk', purchased:true, price:85}],
              outputs:[{name:'Verunreinigtes Aluminiumoxid', unitWeight:2}]},
            {type:'transportkosten', transportCost: 500},
            {type:'verarbeitung', where:'Metallschmelze', duration: 900, processCost: 150,
              inputs:[{name:'Verunreinigtes Aluminiumoxid', qty:10, source:'Ingenieurbüro', purchased:false},{name:'Schlacke', qty:1, source:'Metallschmelze', purchased:true, price:0}],
              outputs:[{name:'Unreiner Aluminiumschrott', unitWeight:2}]},
            {type:'verarbeitung', where:'Metallschmelze', duration: 600, processCost: 0,
              inputs:[{name:'Unreiner Aluminiumschrott', qty:4, source:'Metallschmelze', purchased:false},{name:'Schlacke', qty:1, source:'Metallschmelze', purchased:true, price:0}],
              outputs:[{name:'Aluminiumbarren', unitWeight:1},{name:'Schlacke', unitWeight:1}]},
            {type:'verkauf', where:'Großhändler'}
          ]
        };
        var store=readStore(); store.routes[demo.id]=demo; writeStore(store); refreshRouteSelect(demo.id);
        if(!qs('#listView').hidden){ renderListView(); }
        setRoute(demo);
      });

      // Tabs
      qs('#tabBuilder').addEventListener('click', function(){ switchTab('builder'); });
      qs('#tabList').addEventListener('click', function(){ switchTab('list'); });

      // Initial
      refreshRouteSelect(null);
      setSellList([]); // initiale leere Verkaufsliste
      if(qs('#steps').children.length===0){ addStep('start'); }
      recalc();
    });
  })();
  </script>
</body>
</html>
