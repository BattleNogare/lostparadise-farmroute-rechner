<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Farmrouten-Preisrechner</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f141b; --muted:#161c24; --text:#e6f0ff; --soft:#b7c2d0;
      --green:#00e676; --red:#ff4d4f; --border:#1f2a36; --grid:#0d2a1f; --yellow:#ffd666;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{position:sticky;top:0;z-index:10;background:#0f141b;border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:auto;padding:12px}
    h1{margin:0;font-size:18px}
    .bar{display:grid;grid-template-columns:1fr auto;gap:12px;margin-top:8px}
    .menu{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .card{background:#161c24;border:1px solid #1f2a36;border-radius:12px;padding:16px;margin:16px 0}
    input,select,button,textarea{background:#0f141b;border:1px solid #1f2a36;border-radius:8px;padding:8px;color:#e6f0ff;font:inherit}
    input::placeholder,textarea::placeholder{color:#8aa2b6}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,var(--green),#0bc96e);border:none;color:#022011;font-weight:700}
    button.danger{background:linear-gradient(180deg,#ff7676,#ff4d4f);border:none;color:#2b0004;font-weight:700}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .step{border:1px dashed #1f2a36;border-radius:12px;padding:10px;margin:10px 0}
    .step h3{margin:0 0 6px 0;font-size:14px;color:#b7c2d0}
    .mini{font-size:12px;color:#9bb2c9}
    .summary .row{display:grid;grid-template-columns:1fr auto;gap:8px;padding:6px 0;border-bottom:1px solid #1f2a36}
    .summary .row:last-child{border-bottom:none}
    details{border:1px solid #1f2a36;border-radius:10px;padding:10px;background:#0f141b}
    details>summary{cursor:pointer}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .kpi .box{background:#0f141b;border:1px solid #1f2a36;border-radius:10px;padding:10px}
    .kpi .label{color:#9bb2c9;font-size:12px}
    .kpi .val{font-size:18px;font-weight:700}
    .hr{height:1px;background:linear-gradient(90deg,transparent,#1f2a36,transparent);margin:12px 0}
    .input-list .input-row{display:grid;grid-template-columns:2fr .8fr .8fr 1.2fr auto;gap:6px;margin:6px 0}
    .input-list .input-row input[type="checkbox"]{transform:translateY(2px)}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid #1f2a36;background:#0e171f;font-size:12px}
    .tag.green{border-color:#0a3;background:#062;color:#c6ffdd}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Farmrouten-Preisrechner</h1>
      <div class="bar">
        <div class="menu">
          <select id="savedRoutesSelect" title="Gespeicherte Routen in dieser Seite"></select>
          <button id="saveBtn" type="button">Route speichern</button>
          <button id="deleteBtn" class="danger" type="button">Route löschen</button>
          <button id="downloadPageBtn" class="primary" type="button" title="Neue HTML-Datei mit eingebetteten Routen herunterladen">Seite mit Routen herunterladen</button>
        </div>
        <div class="menu">
          <button id="exportBtn" type="button">Export (JSON)</button>
          <label class="tag" for="importFile" style="cursor:pointer">Import (JSON)
            <input id="importFile" type="file" accept="application/json" style="display:none">
          </label>
          <span class="tag green" id="routeCountTag">0 Routen in dieser Seite</span>
          <button id="demoBtn" type="button">Demo laden</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <section class="card" id="builder">
      <h2>Route zusammenstellen</h2>
      <div class="mini">Lege Basisdaten und Schritte fest. Schritte können mehrfach vorkommen.</div>

      <div class="hr"></div>
      <!-- Basisdaten -->
      <div class="two">
        <label>Endprodukt<br/>
          <input id="endProduct" type="text" placeholder="z. B. Aluminiumbarren">
        </label>
        <label>Eigenen Preis (EUR / Einheit)<br/>
          <input id="customPrice" type="text" placeholder="optional">
        </label>
        <label>Basis-Kilogramm<br/>
          <input id="baseKg" type="number" min="1" step="1" value="2000">
        </label>
        <label style="display:flex; align-items:center; gap:8px; margin-top:8px">
          <input id="includeLicenses" type="checkbox" checked> Lizenzkosten einrechnen
        </label>
      </div>

      <div class="hr"></div>

      <div id="steps"></div>

      <div class="actions">
        <select id="addType">
          <option value="abbau">➕ Abbau</option>
          <option value="fahrzeit">➕ Fahrzeit</option>
          <option value="verarbeitung">➕ Verarbeitung</option>
          <option value="verkauf">➕ Verkaufsort</option>
        </select>
        <button id="addBtn" type="button">Schritt hinzufügen</button>
      </div>
      <div class="mini">Tipp: In „Verarbeitung“ kannst du beliebig viele Inputs je Batch anlegen (gekauft oder aus Bestand).</div>
    </section>

    <aside class="card">
      <h2>Ergebnis & Struktur</h2>
      <div class="kpi">
        <div class="box"><div class="label">Gesamtdauer</div><div id="kpiTime" class="val">–</div></div>
        <div class="box"><div class="label">Gesamtkosten</div><div id="kpiCost" class="val">–</div></div>
        <div class="box"><div class="label">Ausbeute</div><div id="kpiYield" class="val">–</div></div>
      </div>
      <div class="hr"></div>
      <div class="summary" id="summary"></div>
      <div class="hr"></div>
      <details>
        <summary>Preis & Gewinn</summary>
        <div style="margin-top:8px">
          <div class="row"><span>Endprodukt</span> <strong id="sumEndProduct">–</strong></div>
          <div class="row"><span>Einheiten (verkaufbar)</span> <strong id="sumUnits">–</strong></div>
          <div class="row"><span>Break-even (EUR / Einheit)</span> <strong id="sumBreakeven">–</strong></div>
          <div class="row"><span>Vorschlag (≤ 500000 EUR/h)</span> <strong id="sumSuggested">–</strong></div>
          <div class="row"><span>Stundengewinn bei eigenem Preis</span> <strong id="sumHourly">–</strong></div>
        </div>
      </details>
      <div class="mini">Annahme: Batch-Logik. Erster nicht gekaufter Input begrenzt die Batch-Anzahl.</div>
    </aside>
  </main>

  <!-- Schritt-Vorlagen -->
  <template id="tpl-abbau">
    <div class="step" data-type="abbau">
      <h3>Abbau</h3>
      <div class="three">
        <input data-key="what" placeholder="Was wird abgebaut? (z. B. Rohes Bauxit)">
        <input data-key="unitWeight" placeholder="Gewicht pro Einheit (kg)" type="text">
        <input data-key="where" placeholder="Abbauort">
      </div>
      <div class="two">
        <input data-key="time2000" placeholder="Zeit für Basis-Menge (Minuten)" type="text">
      </div>
      <div class="actions">
        <button class="moveUp" type="button">↑</button>
        <button class="moveDown" type="button">↓</button>
        <button class="duplicate" type="button">Duplizieren</button>
        <button class="remove danger" type="button">Entfernen</button>
      </div>
    </div>
  </template>

  <template id="tpl-fahrzeit">
    <div class="step" data-type="fahrzeit">
      <h3>Fahrzeit</h3>
      <div class="three">
        <input data-key="start" placeholder="Startpunkt">
        <input data-key="end" placeholder="Endpunkt">
        <input data-key="minutes" placeholder="Fahrzeit (Minuten)" type="text">
      </div>
      <div class="actions">
        <button class="moveUp" type="button">↑</button>
        <button class="moveDown" type="button">↓</button>
        <button class="duplicate" type="button">Duplizieren</button>
        <button class="remove danger" type="button">Entfernen</button>
      </div>
    </div>
  </template>

  <template id="tpl-verarbeitung">
    <div class="step" data-type="verarbeitung">
      <h3>Verarbeitung</h3>
      <div class="two">
        <input data-key="where" placeholder="Wo wird verarbeitet?">
        <input data-key="duration" placeholder="Dauer pro Batch (Minuten)" type="text">
      </div>
      <div class="mini" style="margin-top:6px">Benötigte Inputs (pro Batch):</div>
      <div class="input-list" data-key="inputs"></div>
      <div class="actions">
        <button class="addInput" type="button">+ Input</button>
      </div>
      <div class="mini" style="margin-top:6px">Ausgabe (pro Batch):</div>
      <div class="three">
        <input data-key="outputName" placeholder="Was wird hergestellt?">
        <input data-key="outputQty" placeholder="Menge / Batch" type="text">
        <input data-key="outputUnitWeight" placeholder="Gewicht / Einheit (kg)" type="text">
      </div>
      <div class="mini" style="margin-top:6px">Lizenz (optional):</div>
      <div class="two">
        <input data-key="licenseName" placeholder="Lizenzname (optional)">
        <input data-key="licensePrice" placeholder="Preis der Lizenz (EUR)" type="text">
      </div>
      <div class="actions">
        <button class="moveUp" type="button">↑</button>
        <button class="moveDown" type="button">↓</button>
        <button class="duplicate" type="button">Duplizieren</button>
        <button class="remove danger" type="button">Entfernen</button>
      </div>
    </div>
  </template>

  <template id="tpl-input-row">
    <div class="input-row">
      <input data-k="name" placeholder="Item-Name">
      <input data-k="qty" placeholder="Menge" type="text">
      <label style="display:flex; align-items:center; gap:6px"><input data-k="purchased" type="checkbox"> einkaufen?</label>
      <input data-k="price" placeholder="Preis / Einheit (EUR)" type="text" title="Nur relevant, wenn 'einkaufen?' aktiv ist">
      <button class="delInput" type="button">✕</button>
    </div>
  </template>

  <template id="tpl-verkauf">
    <div class="step" data-type="verkauf">
      <h3>Verkaufsort</h3>
      <input data-key="where" placeholder="Wo wird verkauft?">
      <div class="actions" style="margin-top:6px">
        <button class="moveUp" type="button">↑</button>
        <button class="moveDown" type="button">↓</button>
        <button class="duplicate" type="button">Duplizieren</button>
        <button class="remove danger" type="button">Entfernen</button>
      </div>
    </div>
  </template>

  <!-- ROUTES DATA (wird in der Datei mitgespeichert) -->
  <!--ROUTES-START-->
  <script id="routes-data" type="application/json">{"routes":{}}</script>
  <!--ROUTES-END-->

  <script>
  (function(){
    // ------- Helpers -------
    function qs(sel,el){return (el||document).querySelector(sel);}
    function qsa(sel,el){return Array.prototype.slice.call((el||document).querySelectorAll(sel));}
    function uid(){return Math.random().toString(36).slice(2,9);}
    var numDE = new Intl.NumberFormat('de-DE',{maximumFractionDigits:2});
    var eur = new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR',maximumFractionDigits:2});
    function fmt(n){return numDE.format(n);}
    function parseNum(v){
      if(v==null) return 0;
      if(typeof v==='number') return v;
      var s=String(v).trim().replace(/\./g,'').replace(',','.');
      var n=parseFloat(s); return isNaN(n)?0:n;
    }
    function minutesToH(m){
      var h=Math.floor(m/60), mi=Math.round(m%60);
      return h<=0 ? (mi+" min") : (h+" h "+mi+" min");
    }
    function debounce(fn,ms){var t; return function(){var a=arguments; clearTimeout(t); t=setTimeout(function(){fn.apply(null,a);},ms);};}

    // ------- Embedded routes storage (in-page) -------
    function readRoutesFromPage(){
      try{
        var n=qs('#routes-data'); if(!n) return {routes:{}};
        var json=JSON.parse(n.textContent||'{}'); if(!json.routes) json.routes={};
        return json;
      }catch(e){ return {routes:{}}; }
    }
    function writeRoutesToScriptTag(obj){
      var n=qs('#routes-data'); if(!n){ n=document.createElement('script'); n.id='routes-data'; n.type='application/json'; document.body.appendChild(n); }
      n.textContent=JSON.stringify(obj);
      updateRouteCountTag();
    }
    function updateRouteCountTag(){
      var data=readRoutesFromPage(); var c=Object.keys(data.routes||{}).length;
      var tag=qs('#routeCountTag'); if(tag){ tag.textContent = c+" Routen in dieser Seite"; }
      refreshSavedSelect(null);
    }
    function downloadUpdatedHTML(){
      // Temporär JSON im Script-Tag aktualisiert lassen und das DOM als HTML herunterladen
      var html = '<!doctype html>' + document.documentElement.outerHTML;
      var blob = new Blob([html], {type:'text/html'});
      var a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='index.html';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ------- Templates & Steps -------
    var TPLS = {
      abbau: function(){return qs('#tpl-abbau').content.firstElementChild.cloneNode(true);},
      fahrzeit: function(){return qs('#tpl-fahrzeit').content.firstElementChild.cloneNode(true);},
      verarbeitung: function(){var el=qs('#tpl-verarbeitung').content.firstElementChild.cloneNode(true); addInputRow(el); return el;},
      verkauf: function(){return qs('#tpl-verkauf').content.firstElementChild.cloneNode(true);}
    };
    function addInputRow(stepEl){
      var row = qs('#tpl-input-row').content.firstElementChild.cloneNode(true);
      qs('[data-key="inputs"]', stepEl).appendChild(row);
      qs('.delInput', row).addEventListener('click', function(){ row.remove(); recalc(); });
    }
    function attachStepControls(stepEl){
      var rm=qs('.remove', stepEl);
      if(rm) rm.addEventListener('click', function(){ stepEl.remove(); recalc(); });
      var du=qs('.duplicate', stepEl);
      if(du) du.addEventListener('click', function(){ var c=stepEl.cloneNode(true); wireStep(c); stepEl.after(c); });
      var up=qs('.moveUp', stepEl);
      if(up) up.addEventListener('click', function(){ var p=stepEl.previousElementSibling; if(p) p.before(stepEl); recalc(); });
      var down=qs('.moveDown', stepEl);
      if(down) down.addEventListener('click', function(){ var n=stepEl.nextElementSibling; if(n) n.after(stepEl); recalc(); });
      var addI=qs('.addInput', stepEl);
      if(addI) addI.addEventListener('click', function(){ addInputRow(stepEl); });
      stepEl.addEventListener('input', debounce(recalc,200));
    }
    function wireStep(stepEl){ attachStepControls(stepEl); }
    function addStep(type){
      var el = TPLS[type](); if(!el) return;
      el.dataset.type = type; wireStep(el); qs('#steps').appendChild(el);
      return el;
    }

    // ------- Route build/render -------
    var currentRouteId = null;
    function getRoute(){
      var steps=[];
      qsa('#steps .step').forEach(function(step){
        var type=step.dataset.type;
        if(type==='abbau'){
          steps.push({type:type,
            what:qs('[data-key="what"]',step).value.trim(),
            unitWeight:parseNum(qs('[data-key="unitWeight"]',step).value),
            where:qs('[data-key="where"]',step).value.trim(),
            time2000:parseNum(qs('[data-key="time2000"]',step).value)
          });
        }else if(type==='fahrzeit'){
          steps.push({type:type,
            start:qs('[data-key="start"]',step).value.trim(),
            end:qs('[data-key="end"]',step).value.trim(),
            minutes:parseNum(qs('[data-key="minutes"]',step).value)
          });
        }else if(type==='verarbeitung'){
          var inputs=qsa('[data-key="inputs"] .input-row',step).map(function(row){
            return {
              name:qs('[data-k="name"]',row).value.trim(),
              qty:parseNum(qs('[data-k="qty"]',row).value),
              purchased:qs('[data-k="purchased"]',row).checked,
              price:parseNum(qs('[data-k="price"]',row).value)
            };
          }).filter(function(x){return x.name && x.qty>0;});
          steps.push({type:type,
            where:qs('[data-key="where"]',step).value.trim(),
            duration:parseNum(qs('[data-key="duration"]',step).value),
            inputs:inputs,
            outputName:qs('[data-key="outputName"]',step).value.trim(),
            outputQty:parseNum(qs('[data-key="outputQty"]',step).value),
            outputUnitWeight:parseNum(qs('[data-key="outputUnitWeight"]',step).value),
            licenseName:qs('[data-key="licenseName"]',step).value.trim(),
            licensePrice:parseNum(qs('[data-key="licensePrice"]',step).value)
          });
        }else if(type==='verkauf'){
          steps.push({type:type, where:qs('[data-key="where"]',step).value.trim()});
        }
      });
      return {
        id: currentRouteId || uid(),
        name: qs('#savedRoutesSelect').selectedOptions[0] ? qs('#savedRoutesSelect').selectedOptions[0].textContent : 'Unbenannt',
        endProduct: qs('#endProduct').value.trim(),
        baseKg: parseNum(qs('#baseKg').value),
        customPrice: (function(v){ var n=parseNum(v); return n>0?n:null; })(qs('#customPrice').value),
        includeLicenses: qs('#includeLicenses').checked,
        steps: steps
      };
    }
    function setRoute(route){
      currentRouteId = route.id || uid();
      qs('#endProduct').value = route.endProduct || '';
      qs('#baseKg').value = route.baseKg || 2000;
      qs('#customPrice').value = route.customPrice!=null ? route.customPrice : '';
      qs('#includeLicenses').checked = route.includeLicenses!==false;
      var stepsBox=qs('#steps'); stepsBox.innerHTML='';
      (route.steps||[]).forEach(function(s){
        var el = addStep(s.type);
        if(s.type==='abbau'){
          qs('[data-key="what"]',el).value = s.what||'';
          qs('[data-key="unitWeight"]',el).value = s.unitWeight||'';
          qs('[data-key="where"]',el).value = s.where||'';
          qs('[data-key="time2000"]',el).value = s.time2000||'';
        }else if(s.type==='fahrzeit'){
          qs('[data-key="start"]',el).value = s.start||'';
          qs('[data-key="end"]',el).value = s.end||'';
          qs('[data-key="minutes"]',el).value = s.minutes||'';
        }else if(s.type==='verarbeitung'){
          qs('[data-key="where"]',el).value = s.where||'';
          qs('[data-key="duration"]',el).value = s.duration||'';
          var list=qs('[data-key="inputs"]',el); list.innerHTML='';
          (s.inputs||[]).forEach(function(inp){
            addInputRow(el);
            var row = list.lastElementChild;
            qs('[data-k="name"]',row).value = inp.name||'';
            qs('[data-k="qty"]',row).value = inp.qty||'';
            qs('[data-k="purchased"]',row).checked = !!inp.purchased;
            qs('[data-k="price"]',row).value = inp.price||'';
          });
          qs('[data-key="outputName"]',el).value = s.outputName||'';
          qs('[data-key="outputQty"]',el).value = s.outputQty||'';
          qs('[data-key="outputUnitWeight"]',el).value = s.outputUnitWeight||'';
          qs('[data-key="licenseName"]',el).value = s.licenseName||'';
          qs('[data-key="licensePrice"]',el).value = s.licensePrice||'';
        }else if(s.type==='verkauf'){
          qs('[data-key="where"]',el).value = s.where||'';
        }
      });
      recalc();
    }

    // ------- Berechnung -------
    function inferEndProduct(route){
      var i;
      for(i=route.steps.length-1;i>=0;i--){ var s=route.steps[i]; if(s.type==='verarbeitung' && s.outputName){ return s.outputName; } }
      for(i=route.steps.length-1;i>=0;i--){ var s2=route.steps[i]; if(s2.type==='abbau' && s2.what){ return s2.what; } }
      return route.endProduct || 'Endprodukt';
    }
    function compute(route){
      var baseKg = route.baseKg>0? route.baseKg : 2000;
      var inventory = {};
      var weights = {};
      var miningTime=0, driveTime=0, procTime=0;
      var purchaseCost=0, licenseCost=0;
      var log=[];

      // Abbau
      route.steps.forEach(function(s,idx){
        if(s.type==='abbau'){
          var perUnit = Math.max(0, parseNum(s.unitWeight));
          var time = Math.max(0, parseNum(s.time2000));
          var what = s.what || ("Rohstoff_"+(idx+1));
          var units = perUnit>0 ? Math.floor(baseKg / perUnit) : 0;
          inventory[what] = (inventory[what]||0) + units;
          if(perUnit>0) weights[what] = perUnit;
          miningTime += time;
          log.push("Abbau "+what+" @"+(s.where||"?")+": "+fmt(units)+" Einheiten (à "+perUnit+" kg). Zeit +"+fmt(time)+" min.");
        }
      });
      // Fahrten
      route.steps.forEach(function(s){
        if(s.type==='fahrzeit'){
          var m = Math.max(0, parseNum(s.minutes));
          driveTime += m;
          log.push("Fahrt "+(s.start||"?")+" → "+(s.end||"?")+": +"+fmt(m)+" min.");
        }
      });
      // Verarbeitung
      route.steps.forEach(function(s,idx){
        if(s.type==='verarbeitung'){
          var inputs = s.inputs||[];
          var nonPurchased = inputs.filter(function(i){return !i.purchased;});
          var primary = nonPurchased[0] || inputs[0];
          if(!primary){
            log.push("Verarbeitung @"+(s.where||"?")+": Kein Input – übersprungen.");
            return;
          }
          var primAvail = inventory[primary.name]||0;
          var primNeed = Math.max(1, parseNum(primary.qty));
          var batches = Math.floor(primAvail/primNeed);
          for(var k=1;k<nonPurchased.length;k++){
            var inp=nonPurchased[k];
            var avail=inventory[inp.name]||0;
            var need=Math.max(1, parseNum(inp.qty));
            var can=Math.floor(avail/need);
            if(can<batches) batches=can;
          }
          if(batches<=0){
            log.push("Verarbeitung @"+(s.where||"?")+": Zu wenig Bestand – übersprungen.");
            return;
          }
          // gekaufte Inputs Kosten
          inputs.filter(function(i){return i.purchased;}).forEach(function(i){
            var need=Math.max(0, parseNum(i.qty));
            var price=Math.max(0, parseNum(i.price));
            purchaseCost += need*batches*price;
          });
          // nicht gekaufte vom Bestand abziehen
          nonPurchased.forEach(function(i){
            var need=Math.max(0, parseNum(i.qty));
            inventory[i.name]=(inventory[i.name]||0)-need*batches;
          });
          // Output
          var outQty=Math.max(0, parseNum(s.outputQty));
          var outName=s.outputName || ("Produkt_"+(idx+1));
          inventory[outName]=(inventory[outName]||0)+outQty*batches;
          var w=parseNum(s.outputUnitWeight); if(w>0) weights[outName]=w;

          var dur=Math.max(0, parseNum(s.duration));
          procTime += dur*batches;
          var lic=Math.max(0, parseNum(s.licensePrice));
          licenseCost += lic;

          // Log
          var inputsTxt = inputs.map(function(i){
            var base = fmt(parseNum(i.qty))+"x "+i.name;
            if(i.purchased){ base += " (gekauft "+eur.format(parseNum(i.price))+")"; }
            return base;
          }).join(" + ");
          log.push(batches+"x @"+(s.where||"?")+": "+inputsTxt+" → "+fmt(outQty)+"x "+outName+". Zeit +"+fmt(dur*batches)+" min"+(lic?(", Lizenz +"+eur.format(lic)):"")+".");
        }
      });
      // Verkaufsorte ins Log
      route.steps.forEach(function(s){ if(s.type==='verkauf'){ log.push("Verkauf @"+(s.where||"?")+"."); } });

      var totalMinutes = miningTime + driveTime + procTime;
      var endName = route.endProduct || inferEndProduct(route);
      var sellableUnits = Math.max(0, Math.floor(inventory[endName]||0));
      var includeLicenses = route.includeLicenses!==false;
      var totalCost = purchaseCost + (includeLicenses? licenseCost : 0);
      var hours = totalMinutes/60;
      var customPrice = route.customPrice;
      var revenueAtCustom = customPrice? (customPrice * sellableUnits) : 0;
      var hourlyProfit = customPrice? ((revenueAtCustom - totalCost) / Math.max(0.0001, hours)) : null;
      var breakEvenPerUnit = sellableUnits>0? (totalCost / sellableUnits) : 0;
      var suggestedPerUnit = sellableUnits>0? Math.max(breakEvenPerUnit, (500000*hours + totalCost) / sellableUnits) : 0;

      return {
        miningTime:miningTime, driveTime:driveTime, procTime:procTime, totalMinutes:totalMinutes,
        purchaseCost:purchaseCost, licenseCost:licenseCost, totalCost:totalCost,
        endName:endName, sellableUnits:sellableUnits, hours:hours,
        breakEvenPerUnit:breakEvenPerUnit, suggestedPerUnit:suggestedPerUnit, hourlyProfit:hourlyProfit,
        log:log
      };
    }
    function renderSummary(calc){
      qs('#kpiTime').textContent = minutesToH(calc.totalMinutes);
      qs('#kpiCost').textContent = eur.format(calc.totalCost);
      qs('#kpiYield').textContent = fmt(calc.sellableUnits) + " x " + calc.endName;

      var box = qs('#summary'); box.innerHTML='';
      var rows = [
        ["Mining", minutesToH(calc.miningTime)+" ("+fmt(calc.miningTime)+" min)"],
        ["Fahrten", minutesToH(calc.driveTime)+" ("+fmt(calc.driveTime)+" min)"],
        ["Verarbeitung", minutesToH(calc.procTime)+" ("+fmt(calc.procTime)+" min)"],
        ["Kosten (Einkauf)", eur.format(calc.purchaseCost)],
        ["Lizenzkosten", eur.format(calc.licenseCost)],
        ["Gesamtkosten", eur.format(calc.totalCost)]
      ];
      rows.forEach(function(x){
        var r=document.createElement('div'); r.className='row';
        r.innerHTML = "<span>"+x[0]+"</span><strong>"+x[1]+"</strong>";
        box.appendChild(r);
      });

      var det=document.createElement('details'); det.open=true; det.innerHTML="<summary>Routenstruktur</summary>";
      var ul=document.createElement('ul'); ul.style.marginTop='8px';
      calc.log.forEach(function(t){ var li=document.createElement('li'); li.textContent=t; ul.appendChild(li); });
      det.appendChild(ul); box.appendChild(det);

      qs('#sumEndProduct').textContent = calc.endName;
      qs('#sumUnits').textContent = fmt(calc.sellableUnits);
      qs('#sumBreakeven').textContent = calc.sellableUnits>0 ? eur.format(calc.breakEvenPerUnit) : "–";
      qs('#sumSuggested').textContent = calc.sellableUnits>0 ? eur.format(calc.suggestedPerUnit) : "–";
      qs('#sumHourly').textContent = (calc.hourlyProfit==null) ? "–" : eur.format(calc.hourlyProfit);
    }
    function recalc(){
      var route=getRoute();
      var calc=compute(route);
      renderSummary(calc);
    }

    // ------- Routes UI (in-page map) -------
    function getRoutesMap(){ return readRoutesFromPage().routes || {}; }
    function setRoutesMap(map){ writeRoutesToScriptTag({routes:map}); }
    function refreshSavedSelect(selectedId){
      var sel=qs('#savedRoutesSelect');
      if(!sel) return;
      var map=getRoutesMap();
      sel.innerHTML='';
      var opt0=document.createElement('option'); opt0.value=''; opt0.textContent='— Gespeicherte Routen —';
      sel.appendChild(opt0);
      Object.keys(map).forEach(function(id){
        var r=map[id]; var o=document.createElement('option');
        o.value=id; o.textContent=r.name||id; if(id===selectedId) o.selected=true; sel.appendChild(o);
      });
    }

    // ------- Events -------
    window.addEventListener('DOMContentLoaded', function(){
      // Add button + fallback delegation
      var addBtn=qs('#addBtn');
      if(addBtn){
        addBtn.addEventListener('click', function(){
          var type=qs('#addType').value; addStep(type);
        });
      }
      qs('#builder').addEventListener('click', function(e){
        if(e.target && e.target.id==='addBtn'){ var t=qs('#addType').value; addStep(t); }
      });

      // Basisdaten change
      ['endProduct','customPrice','baseKg','includeLicenses'].forEach(function(id){
        var el=qs('#'+id); if(el) el.addEventListener('input', debounce(recalc,180));
      });

      // Save route into in-page JSON
      qs('#saveBtn').addEventListener('click', function(){
        var r=getRoute();
        if(!r.name || r.name==='Unbenannt'){ var n=prompt('Name der Route?'); if(n) r.name=n; }
        var map=getRoutesMap(); map[r.id]=r; setRoutesMap(map);
        currentRouteId=r.id; refreshSavedSelect(r.id);
        alert('Route in diese Seite gespeichert. Vergiss nicht: "Seite mit Routen herunterladen" um die Datei zu aktualisieren.');
      });
      // Delete
      qs('#deleteBtn').addEventListener('click', function(){
        var id=qs('#savedRoutesSelect').value; if(!id){ alert('Bitte eine gespeicherte Route wählen.'); return; }
        if(confirm('Route wirklich löschen?')){
          var map=getRoutesMap(); delete map[id]; setRoutesMap(map);
          refreshSavedSelect(null);
        }
      });
      // Load
      qs('#savedRoutesSelect').addEventListener('change', function(e){
        var id=e.target.value; if(!id) return;
        var map=getRoutesMap(); if(map[id]){ setRoute(map[id]); currentRouteId=id; }
      });

      // Download updated page
      qs('#downloadPageBtn').addEventListener('click', function(){ downloadUpdatedHTML(); });

      // Export / Import JSON
      qs('#exportBtn').addEventListener('click', function(){
        var data = {routes:getRoutesMap()};
        var blob=new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='routen.json'; a.click(); URL.revokeObjectURL(a.href);
      });
      qs('#importFile').addEventListener('change', function(e){
        var f=e.target.files && e.target.files[0]; if(!f) return;
        var rd=new FileReader();
        rd.onload=function(){
          try{
            var incoming=JSON.parse(rd.result||'{}'); var map=getRoutesMap(); var rts=incoming.routes||incoming||{};
            Object.keys(rts).forEach(function(id){
              var r=rts[id]; if(!r.id){ r.id=uid(); } map[r.id]=r;
            });
            setRoutesMap(map); refreshSavedSelect(null); alert('Import abgeschlossen.');
          }catch(err){ alert('Import fehlgeschlagen: '+err.message); }
        };
        rd.readAsText(f);
        e.target.value='';
      });

      // Demo
      qs('#demoBtn').addEventListener('click', function(){
        var demo={
          id: uid(),
          name: 'Bauxit → Aluminiumbarren (Demo)',
          endProduct: 'Aluminiumbarren',
          baseKg: 2000,
          customPrice: 0,
          includeLicenses: true,
          steps: [
            {type:'abbau', what:'Rohes Bauxit', unitWeight:3, where:'Bauxitmine', time2000: 180},
            {type:'verarbeitung', where:'Ingenieurbüro', duration: 8,
              inputs:[{name:'Rohes Bauxit', qty:10, purchased:false}],
              outputName:'Feingemahlenes Bauxitpulver', outputQty:10, outputUnitWeight:3,
              licenseName:'', licensePrice:0},
            {type:'verarbeitung', where:'Ingenieurbüro', duration: 12,
              inputs:[{name:'Feingemahlenes Bauxitpulver', qty:10, purchased:false},{name:'Schwefelsäure', qty:3, purchased:true, price:85}],
              outputName:'Verunreinigtes Aluminiumoxid', outputQty:10, outputUnitWeight:2,
              licenseName:'', licensePrice:0},
            {type:'verarbeitung', where:'Metallschmelze', duration: 15,
              inputs:[{name:'Verunreinigtes Aluminiumoxid', qty:10, purchased:false},{name:'Schlacke', qty:1, purchased:true, price:0}],
              outputName:'Unreiner Aluminiumschrott', outputQty:8, outputUnitWeight:2,
              licenseName:'', licensePrice:0},
            {type:'verarbeitung', where:'Metallschmelze', duration: 10,
              inputs:[{name:'Unreiner Aluminiumschrott', qty:4, purchased:false},{name:'Schlacke', qty:1, purchased:true, price:0}],
              outputName:'Aluminiumbarren', outputQty:5, outputUnitWeight:1,
              licenseName:'Schmelz-Lizenz', licensePrice:10000},
            {type:'verkauf', where:'Großhändler'}
          ]
        };
        setRoute(demo);
      });

      // Erste UI
      updateRouteCountTag();
      if(qs('#steps').children.length===0){ addStep('abbau'); }
      recalc();
    });
  })();
  </script>
</body>
</html>
