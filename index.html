<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Farmrouten-Preisrechner</title>
  <style>
    body{background:#0b0f14;color:#e6f0ff;font-family:system-ui,sans-serif;margin:0;padding:0}
    header{background:#0f141b;padding:10px;position:sticky;top:0;z-index:10}
    h1{margin:0;font-size:18px}
    .wrap{max-width:1100px;margin:auto;padding:10px}
    .card{background:#161c24;border:1px solid #1f2a36;border-radius:12px;padding:16px;margin-bottom:16px}
    input,select,button{background:#0f141b;border:1px solid #1f2a36;border-radius:8px;padding:8px;color:#e6f0ff}
    button{cursor:pointer}
    .step{border:1px dashed #1f2a36;border-radius:12px;padding:10px;margin:10px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .row label{display:flex;gap:6px;align-items:center}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Farmrouten-Preisrechner</h1>
      <div class="row">
        <select id="routeSelect" title="In dieser Sitzung gespeicherte Routen"></select>
        <button id="saveBtn" type="button">Aktuelle Route speichern</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card" id="builder">
      <h2>Route zusammenstellen</h2>

      <div class="row" style="margin-bottom:10px">
        <label>Endprodukt:
          <input id="endProduct" type="text" placeholder="z. B. Aluminiumbarren">
        </label>
        <label>Eigener Preis (€ / Einheit):
          <input id="customPrice" type="number" step="0.01" placeholder="optional">
        </label>
        <label>LKW-Größe (kg):
          <input id="baseKg" type="number" value="2000" min="1" step="1">
        </label>
        <label>Rucksack-Größe (kg):
          <input id="rucksackKg" type="number" value="100" min="1" step="1">
        </label>
      </div>

      <div id="steps"></div>

      <div class="row">
        <select id="addType">
          <option value="abbau">➕ Abbau</option>
          <option value="fahrzeit">➕ Fahrzeit</option>
          <option value="verarbeitung">➕ Verarbeitung</option>
          <option value="verkauf">➕ Verkaufsort</option>
        </select>
        <button id="addBtn" type="button">Schritt hinzufügen</button>
      </div>
    </section>

    <section class="card">
      <h2>Ergebnis</h2>
      <div id="summary">Noch keine Berechnung.</div>
    </section>
  </main>

  <!-- Schritt-Vorlagen -->
  <template id="tpl-abbau">
    <div class="step" data-type="abbau">
      <h3>Abbau</h3>
      <div class="row">
        <input data-key="what" placeholder="Was wird abgebaut?">
        <input data-key="unitWeight" placeholder="Gewicht pro Einheit (kg)" type="number" min="0" step="0.01">
        <input data-key="where" placeholder="Wo wird abgebaut?">
        <input data-key="time2000" placeholder="Zeit für 2000kg (Minuten)" type="number" min="0" step="1">
      </div>
    </div>
  </template>

  <template id="tpl-fahrzeit">
    <div class="step" data-type="fahrzeit">
      <h3>Fahrzeit</h3>
      <div class="row">
        <input data-key="start" placeholder="Startpunkt">
        <input data-key="end" placeholder="Endpunkt">
        <input data-key="minutes" placeholder="Fahrzeit (Minuten)" type="number" min="0" step="1">
      </div>
    </div>
  </template>

  <template id="tpl-verarbeitung">
    <div class="step" data-type="verarbeitung">
      <h3>Verarbeitung</h3>
      <div class="row">
        <input data-key="where" placeholder="Wo wird verarbeitet?">
        <input data-key="duration" placeholder="Dauer pro Batch (Minuten)" type="number" min="0" step="1">
      </div>
      <div class="row">
        <input data-key="outputName" placeholder="Was wird hergestellt?">
        <input data-key="outputQty" placeholder="Menge / Batch" type="number" min="0" step="1">
        <input data-key="outputUnitWeight" placeholder="Gewicht / Einheit (kg)" type="number" min="0" step="0.01">
      </div>
      <div class="row">
        <input data-key="licenseName" placeholder="Lizenzname">
        <input data-key="licensePrice" placeholder="Preis Lizenz (€)" type="number" min="0" step="0.01">
      </div>
    </div>
  </template>

  <template id="tpl-verkauf">
    <div class="step" data-type="verkauf">
      <h3>Verkaufsort</h3>
      <div class="row">
        <input data-key="where" placeholder="Wo wird verkauft?">
      </div>
    </div>
  </template>

  <script>
    // ---------- Helpers ----------
    const qs  = (sel,el=document)=>el.querySelector(sel);
    const qsa = (sel,el=document)=>Array.from(el.querySelectorAll(sel));

    function addStep(type){
      const tpl = qs('#tpl-'+type);
      if(!tpl || !tpl.content || !tpl.content.firstElementChild) return;
      const clone = tpl.content.firstElementChild.cloneNode(true);
      qs('#steps').appendChild(clone);
    }

    function getCurrentRoute(){
      const steps=[];
      qsa('#steps .step').forEach(step=>{
        const obj={type:step.dataset.type};
        qsa('input',step).forEach(inp=>{
          const k = (inp.dataset && inp.dataset.key) ? inp.dataset.key : null;
          if(k) obj[k]=inp.value;
        });
        steps.push(obj);
      });
      return {
        endProduct:qs('#endProduct').value,
        customPrice:qs('#customPrice').value,
        baseKg:parseFloat(qs('#baseKg').value)||2000,
        rucksackKg:parseFloat(qs('#rucksackKg').value)||100,
        steps
      };
    }

    function saveRoute(){
      const route=getCurrentRoute();
      const all=JSON.parse(sessionStorage.getItem('routes')||'[]');
      all.push(route);
      sessionStorage.setItem('routes',JSON.stringify(all));
      refreshRouteSelect();
    }

    function refreshRouteSelect(){
      const sel=qs('#routeSelect');
      if(!sel) return;
      sel.innerHTML='';
      const all=JSON.parse(sessionStorage.getItem('routes')||'[]');
      const opt0=document.createElement('option');
      opt0.value=''; opt0.textContent='— Gespeicherte Routen (Sitzung) —';
      sel.appendChild(opt0);
      all.forEach((r,i)=>{
        const opt=document.createElement('option');
        opt.value=i; opt.textContent=r.endProduct||('Route '+(i+1));
        sel.appendChild(opt);
      });
    }

    function recalc(){
      const route=getCurrentRoute();
      const lkw=route.baseKg;
      const rucksack=route.rucksackKg;
      const ladungen=Math.ceil(lkw/rucksack);
      let text=`LKW: ${lkw} kg, Rucksack: ${rucksack} kg → ${ladungen} Ladungen.\n`;

      route.steps.forEach(s=>{
        if(s.type==='verarbeitung'){
          const outName=s.outputName||'Produkt';
          const outQty=parseFloat(s.outputQty)||0;
          const outWeight=parseFloat(s.outputUnitWeight)||0;
          const totalUnits=outQty*ladungen;
          const totalWeight=totalUnits*outWeight;
          text+=`Verarbeitung: ${totalUnits}× ${outName} (${totalWeight} kg) in ${ladungen} Vorgängen.\n`;
        }
      });

      qs('#summary').innerText=text;
    }

    // ---------- Init / Events ----------
    function bindOnce(el, event, handler){
      if(!el) return;
      if(el.dataset && el.dataset.bound===event) return;
      el.addEventListener(event, handler);
      if(el.dataset) el.dataset.bound = event;
    }

    function init(){
      // Add button (robust, nur einmal)
      bindOnce(qs('#addBtn'),'click',()=>{
        const type = qs('#addType')?.value || 'abbau';
        addStep(type);
      });

      // Speichern
      bindOnce(qs('#saveBtn'),'click',saveRoute);

      // Route laden
      bindOnce(qs('#routeSelect'),'change',e=>{
        const all=JSON.parse(sessionStorage.getItem('routes')||'[]');
        const r=all[e.target.value];
        if(r){
          qs('#endProduct').value=r.endProduct||'';
          qs('#customPrice').value=r.customPrice||'';
          qs('#baseKg').value=r.baseKg||2000;
          qs('#rucksackKg').value=r.rucksackKg||100;
          qs('#steps').innerHTML='';
          (r.steps||[]).forEach(s=>addStep(s.type));
          recalc();
        }
      });

      // Recalc bei Eingaben
      ['endProduct','customPrice','baseKg','rucksackKg'].forEach(id=>{
        const el=qs('#'+id);
        if(el) bindOnce(el,'input',recalc);
      });

      refreshRouteSelect();
      recalc();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
