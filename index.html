<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Farmrouten-Preisrechner</title>
  <link rel="icon" type="image/x-icon"
        href="https://raw.githubusercontent.com/favicon.ico" />
  <style>
    body{margin:0;padding:0;font-family:sans-serif;background:#f5f5f5;color:#222;}
    header{background:#333;color:#fff;padding:8px 12px;display:flex;justify-content:space-between;align-items:center;}
    header h1{margin:0;font-size:18px;}
    .tag{padding:2px 6px;border-radius:4px;font-size:12px;}
    .green{background:#2ecc71;color:#fff;}
    .yellow{background:#f1c40f;color:#000;}
    .flex{display:flex;gap:10px;}
    main{display:flex;flex-wrap:nowrap;gap:10px;padding:10px;height:calc(100vh - 60px);box-sizing:border-box;}
    #builderView,#resultView{background:#fff;border-radius:8px;padding:10px;overflow:auto;}
    #builderView{flex:1.2;}
    #resultView{flex:1;}
    .card h2{margin-top:0;}
    .trade-list .trade-row{display:grid;grid-template-columns:1fr 1.2fr .7fr .9fr auto;gap:6px;align-items:center;}
    .trade-list input,.trade-list select{width:100%;box-sizing:border-box;}
    .trade-list button.delTrade{background:#e74c3c;border:none;color:#fff;border-radius:4px;cursor:pointer;}
    .trade-list button.delTrade:hover{background:#c0392b;}
    #authOverlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;}
    #authOverlay.active{display:flex;}
    #authBox{background:#fff;padding:20px;border-radius:8px;min-width:280px;text-align:center;}
    #authBox input{width:100%;margin-top:8px;padding:6px;}
    #authBox button{margin-top:10px;padding:6px 12px;}
  </style>
</head>
<body>
  <header>
    <h1>Farmrouten-Preisrechner</h1>
    <span id="driveState" class="tag yellow" title="Sheets-Verbindung">Sheets: nicht verbunden</span>
  </header>

  <main>
    <section class="card" id="builderView">
      <h2>Route Builder</h2>
      <div class="trade-list" data-key="moves">
        <div class="trade-row">
          <select data-k="action" title="Aktion">
            <option value="kaufen">kaufen</option>
            <option value="verkaufen">verkaufen</option>
          </select>
          <input data-k="name" placeholder="Item-Name">
          <input data-k="qty" placeholder="Menge (Einheiten)" type="number" step="1" min="0">
          <input data-k="price" placeholder="Preis/Einheit (€)" type="number" step="0.01" min="0">
          <button class="delTrade" type="button">✕</button>
        </div>
      </div>
    </section>

    <section class="card" id="resultView">
      <h2>Ergebnis</h2>
      <div id="resultArea">–</div>
    </section>
  </main>

  <!-- AUTH OVERLAY -->
  <div id="authOverlay">
    <div id="authBox">
      <h3>Verbinde mit Sheets-Backend</h3>
      <input id="authToken" placeholder="Token eingeben">
      <button id="authBtn">Verbinden</button>
      <div id="authMsg" style="margin-top:6px;color:#c00;font-size:13px;"></div>
    </div>
  </div>

<script>
/* === BASIC STORE HELPERS === */
function readStore(){ try{return JSON.parse(localStorage.farmStore||'{}');}catch(_){return{};} }
function writeStore(s){ localStorage.farmStore=JSON.stringify(s); }
function getToken(){ return localStorage.farmToken||''; }
function setToken(t){ localStorage.farmToken=t||''; }
function qs(s){return document.querySelector(s);}
function updateDriveStateTag(ok){
  const el=qs('#driveState');
  if(!el)return;
  if(ok){ el.textContent='Sheets: verbunden'; el.classList.add('green'); el.classList.remove('yellow'); }
  else{ el.textContent='Sheets: nicht verbunden'; el.classList.add('yellow'); el.classList.remove('green'); }
}

/* === AUTH OVERLAY === */
function showAuth(msg){
  qs('#authOverlay').classList.add('active');
  if(msg)qs('#authMsg').textContent=msg;else qs('#authMsg').textContent='';
}
function hideAuth(){ qs('#authOverlay').classList.remove('active'); }

qs('#authBtn').onclick=()=>{
  const t=qs('#authToken').value.trim();
  if(!t)return;
  setToken(t);
  hideAuth();
  tryAuthAndLoad(true);
};

/* === GLOBAL CONFIG === */
const GAS_URL='https://script.google.com/macros/s/AKfycbwXqVfkK787fVfLawjUslxaYkvdKNthPGHdatoIjWT6VLgc2cYyVITo1nc4tR2KG3hK/exec';
const DRIVE_AUTO_LOAD=true;

/* === UNIVERSAL REQUEST === */
async function requestJSON(url){
  try{
    const res=await fetch(url,{method:'GET',mode:'cors',credentials:'omit'});
    if(res.ok){
      const data=await res.json();
      return{ok:true,data,via:'cors'};
    }
  }catch(_){}
  // fallback JSONP
  return new Promise(resolve=>{
    const cb='cb_'+Math.random().toString(36).slice(2);
    const sep=url.includes('?')?'&':'?';
    const s=document.createElement('script');
    const timer=setTimeout(()=>{cleanup();resolve({ok:false,error:'timeout',via:'jsonp'});},8000);
    function cleanup(){clearTimeout(timer);delete window[cb];if(s.parentNode)s.parentNode.removeChild(s);}
    window[cb]=function(payload){cleanup();resolve({ok:true,data:payload,via:'jsonp'});}
    s.onerror=function(){cleanup();resolve({ok:false,error:'load_error',via:'jsonp'});}
    s.src=url+sep+'callback='+cb;
    s.async=true;
    document.head.appendChild(s);
  });
}
function serverSaysBadToken(p){
  if(!p||typeof p!=='object')return false;
  if(p.ok===false&&/token/i.test(String(p.error||'')))return true;
  if(String(p.status||'').toLowerCase()==='error'&&/token/i.test(String(p.message||p.error||'')))return true;
  return false;
}

/* === API FUNCTIONS === */
async function gasListRoutes(){
  const url=GAS_URL+'?action=list&token='+encodeURIComponent(getToken());
  const res=await requestJSON(url);
  if(!res.ok)throw new Error('list-req-fail '+res.via);
  const data=res.data;
  if(serverSaysBadToken(data)){const e=new Error('bad_token');e._badToken=true;throw e;}
  const store=readStore();
  store.travelTimes=Object.assign({},store.travelTimes||{},data.travelTimes||data.times||{});
  writeStore(store);
  let routes=[];
  if(Array.isArray(data.routes))routes=data.routes;
  else if(data.routes&&typeof data.routes==='object'){
    routes=Object.keys(data.routes).map(id=>({id,name:data.routes[id].name||id,_full:data.routes[id]}));
  }else if(Array.isArray(data.items))routes=data.items;
  if(routes.some(r=>r._full&&Array.isArray(r._full.steps))){
    const s=readStore();
    routes.forEach(m=>{const f=m._full;if(f&&f.id)s.routes=f;});
    writeStore(s);
  }
  return routes;
}
async function gasGetRoute(id){
  const url=GAS_URL+'?action=get&id='+encodeURIComponent(id)+'&token='+encodeURIComponent(getToken());
  const res=await requestJSON(url);
  if(!res.ok)throw new Error('get-req-fail '+res.via);
  const d=res.data;
  if(serverSaysBadToken(d)){const e=new Error('bad_token');e._badToken=true;throw e;}
  const r=d.route||d.data||d;
  if(!r||!Array.isArray(r.steps))throw new Error('route missing');
  return r;
}
async function gasSaveRoute(route){
  try{
    const res=await fetch(GAS_URL,{method:'POST',mode:'cors',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'save',token:getToken(),route})});
    try{const d=await res.json();if(serverSaysBadToken(d)){const e=new Error('bad_token');e._badToken=true;throw e;}}catch(_){}
  }catch(_){
    await fetch(GAS_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'save',token:getToken(),route})});
  }
  return true;
}
async function gasDeleteRoute(id){
  try{
    const res=await fetch(GAS_URL,{method:'POST',mode:'cors',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'delete',token:getToken(),id})});
    try{const d=await res.json();if(serverSaysBadToken(d)){const e=new Error('bad_token');e._badToken=true;throw e;}}catch(_){}
  }catch(_){
    await fetch(GAS_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'delete',token:getToken(),id})});
  }
  return true;
}

/* === SYNC + AUTH FLOW === */
async function syncFromSheetIntoPage(){
  try{
    const metas=await gasListRoutes();
    const store=readStore();
    for(const m of metas){
      if(!m._full){
        try{const r=await gasGetRoute(m.id);store.routes=store.routes||{};store.routes[r.id]=r;}
        catch(e){console.warn('fetch route fail',m.id,e);}
      }else{store.routes=store.routes||{};store.routes[m.id]=m._full;}
    }
    writeStore(store);
    updateDriveStateTag(true);
  }catch(e){
    console.warn('sync fail',e);
    updateDriveStateTag(false);
  }
}
async function tryAuthAndLoad(initial=false){
  const t=getToken();
  if(!t){showAuth();return;}
  try{
    await gasListRoutes();
    hideAuth();
    updateDriveStateTag(true);
    if(initial&&DRIVE_AUTO_LOAD)await syncFromSheetIntoPage();
  }catch(e){
    updateDriveStateTag(false);
    if(e&&e._badToken){setToken('');showAuth('Falsches Token');}
    else showAuth('Verbindung fehlgeschlagen');
  }
}

/* === INIT === */
window.addEventListener('DOMContentLoaded',()=>{tryAuthAndLoad(true);});
</script>
</body>
</html>
